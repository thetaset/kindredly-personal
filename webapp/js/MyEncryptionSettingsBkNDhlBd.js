import{U as D}from"./UserEncryptionSettingsComponent0OJgUW7q.js";import{I as z}from"./InfoModaltif1aJzA.js";import j from"./VerifyPassword-VCt61lZ.js";import{U as G}from"./UpdatePasswordmNzRQTqc.js";import{a as O,aI as Q,aK as R,_ as Y}from"./components.globalBic2x0kT.js";import{d as H,j as r,K as a,z as p,k as t,Q as i,R as c,s as d,r as u,i as o,F as J,P as W,m}from"./@vueC3Nhqlrl.js";import"./bootstrap-vue-nextDnMzdrWQ.js";import"./vue3-toastifyDll2FbVh.js";import"./@capacitorCjBcbZvA.js";const X=H({name:"MyEncryptionSettings",mixins:[O],components:{UserEncryptionSettingsComponent:D,InfoModal:z,VerifyPassword:j,UpdatePassword:G},data(){return{password:null,loading:!1,enterRecoveryKey:!1,providedRecoveryKey:null,userToFix:null,resetPassword:!1,passwordChanged:!1,childComponentKey:0,loadingPage:!0}},mounted(){},computed:{...Q},methods:{async shareAccountKey(s=null){this.loading=!0;try{const e=await this.apiReq("/client/encryption/shareAccountKey",{userId:s});await R()}catch(e){this.showToast("Error: "+e.message,{variant:"danger"})}this.loading=!1},async recoverUsingKey(){if(!this.providedRecoveryKey){this.showToast("Please enter your recovery key",{variant:"danger"});return}if(!this.resetPassword&&!this.password){this.showToast("Please enter your password",{variant:"danger"});return}try{const s=await this.apiReq("/client/encryption/recoverUsingKey",{recoveryKey:this.providedRecoveryKey,password:this.password});this.showToast("Successfully recovered using recovery key",{variant:"success"}),window.location.reload()}catch(s){this.showToast("Error: "+s.message,{variant:"danger"})}},fixUser(s){this.userToFix=s,this.showModal("fix-user-modal")},async setPassword(s){this.password=s,this.passwordChanged=!0,await this.LoadEncStatus(!0)},async refreshChild(){this.childComponentKey++},async loadPage(){this.loadingPage=!0;try{await this.LoadEncStatus(!0),this.isAdminUser&&await R()}finally{this.loadingPage=!1}}},created(){this.loadPage()}}),Z={class:"mb-4 d-flex flex-gap-1 align-items-center"},x={key:0},_={key:1},ee={key:0},se={key:1,class:"success-color"},te={key:2,class:"mt-4"},oe={key:3,class:"mt-4 d-flex justify-content-end"},ne={class:"container-fluid-max1200 pb-4"},re={class:"text-muted"},ie={key:0},ae={key:1,class:"mt-4"},le={key:2,class:"mt-4"},de={key:3,class:"mt-4"},ue={key:4,class:"alert alert-warning mt-4"},ye={key:5,class:"alert alert-warning mt-4"},pe={class:"mt-2"},me={key:6,class:"alert alert-warning mt-4"},ce={key:7,class:"alert alert-warning mt-4"},ve={key:0,class:"mt-2"},we={key:8,class:"my-4 border rounded p-3"},ge={key:0},ke={class:""},fe={key:1},be={class:"small text-muted"},Se={class:"small mt-2"},Ee={class:"mt-3"},Pe={key:1,class:"small danger-color"},Ue={key:2,class:"small danger-color"},he={key:3,class:"mb-2 small danger-color"},Ce={key:4},Ke={key:9,class:"text-center my-3"},Re={key:0};function Ve(s,e,Ae,Ie,Te,$e){const V=u("b-form-checkbox"),w=u("b-form-input"),A=u("UpdatePassword"),v=u("b-button"),I=u("b-modal"),T=u("InfoModal"),l=u("b-icon"),$=u("VerifyPassword"),N=u("b-link"),M=u("b-spinner"),q=u("UserEncryptionSettingsComponent"),F=u("b-col"),L=u("b-row");return o(),r("div",null,[a(I,{id:"enc-recovery-modal","hide-footer":"",title:"Recover Encrypted Data"},{default:p(()=>[t("div",null,[t("div",null,[t("div",Z,[a(V,{modelValue:s.resetPassword,"onUpdate:modelValue":e[0]||(e[0]=y=>s.resetPassword=y)},null,8,["modelValue"]),e[10]||(e[10]=i(" Reset Current Password "))])]),e[15]||(e[15]=t("hr",null,null,-1)),s.resetPassword?(o(),r("div",_,[s.passwordChanged?(o(),r("div",se,"New password set")):(o(),r("div",ee,[e[12]||(e[12]=t("div",{class:"text-muted mb-2"},"Set New Password",-1)),a(A,{needCurrentPassword:!1,onPassword:e[2]||(e[2]=y=>s.setPassword(y))})]))])):(o(),r("div",x,[e[11]||(e[11]=t("div",{class:"text-muted mb-2"},"Enter your current password",-1)),a(w,{modelValue:s.password,"onUpdate:modelValue":e[1]||(e[1]=y=>s.password=y),class:"",small:"",placeholder:"Enter current password",type:"password"},null,8,["modelValue"])])),s.password||!s.resetPassword?(o(),r("div",te,[e[13]||(e[13]=t("div",{class:"text-muted mb-2"},"Recovery key",-1)),a(w,{modelValue:s.providedRecoveryKey,"onUpdate:modelValue":e[3]||(e[3]=y=>s.providedRecoveryKey=y),small:"",placeholder:"Enter encryption recovery key"},null,8,["modelValue"])])):d("",!0),s.password?(o(),r("div",oe,[a(v,{variant:"primary",onClick:e[4]||(e[4]=y=>s.recoverUsingKey())},{default:p(()=>e[14]||(e[14]=[i("Recover")])),_:1})])):d("",!0)])]),_:1}),t("div",ne,[t("div",null,[e[22]||(e[22]=t("h2",{class:"my-3"},"Encryption Settings",-1)),t("div",re,[e[20]||(e[20]=i(" Kindredly stores your data using ")),a(T,{title:"End-to-end encryption"},{trigger:p(()=>e[16]||(e[16]=[t("span",{class:"linklike",role:"button"},"end-to-end encryption ",-1)])),default:p(()=>[e[17]||(e[17]=i(" By default, we use end-to-end encryption on data such as text, images, videos and other files stored in Kindredly ")),e[18]||(e[18]=t("br",null,null,-1)),e[19]||(e[19]=t("br",null,null,-1))]),_:1}),e[21]||(e[21]=i(". If you don't share your password or recovery key, no one else can access your data. Not even us. "))])]),a(L,null,{default:p(()=>[a(F,{class:"col"},{default:p(()=>{var y,g,k,f,b,S,E,P,U,h,C,K;return[s.encStatus?d("",!0):(o(),r("div",ie,"...")),(y=s.encStatus)!=null&&y.userEncEnabled?(o(),r("div",ae,[a(l,{icon:"check-circle",class:"me-1",style:{color:"green"}}),e[23]||(e[23]=i(" Encryption Enabled "))])):(g=s.encStatus)!=null&&g.acntEncSupported?(k=s.encStatus)!=null&&k.userEncSetup?(f=s.encStatus)!=null&&f.needsPassword&&!((b=s.encStatus)!=null&&b.userEncEnabled)?(o(),r("div",ue,[t("div",null,[a(l,{icon:"exclamation-triangle"}),e[26]||(e[26]=i(" Encryption is disabled. "))]),e[27]||(e[27]=t("div",{class:"my-2 small text-muted"}," Enter your password to enable encryption ",-1)),a($,{onClose:e[5]||(e[5]=n=>{s.loadPage(),s.refreshChild()})}),t("div",{role:"button",class:"mt-2 linkcolor small text-primary",onClick:e[6]||(e[6]=n=>s.showModal("enc-recovery-modal"))}," or use recovery key ")])):(S=s.encStatus)!=null&&S.userEncSetup&&!((E=s.encStatus)!=null&&E.userEncEnabled)?(o(),r("div",ye,[a(l,{icon:"exclamation-triangle"}),e[31]||(e[31]=t("strong",null,"Encryption Issue:",-1)),e[32]||(e[32]=i(" Passwords may not be synchronized. This can be caused by resetting your password. ")),e[33]||(e[33]=t("div",{class:"mt-2"},null,-1)),e[34]||(e[34]=i(" To recover your encrypted data, you have the following options: ")),t("ul",pe,[e[30]||(e[30]=t("li",null," Reset your password again to the same password you used for encryption. ",-1)),t("li",null,[e[28]||(e[28]=i(" Use your ")),t("span",{role:"button",class:"linkcolor text-primary",onClick:e[7]||(e[7]=n=>s.showModal("enc-recovery-modal"))},"recovery key"),e[29]||(e[29]=i(" to reset your encryption password to you current password. "))])])])):d("",!0):(o(),r("div",de,[a(l,{icon:"info-circle",class:"me-1"}),e[25]||(e[25]=i(" Encryption has not be setup for your user. "))])):(o(),r("div",le,[a(l,{icon:"info-circle",class:"me-1"}),e[24]||(e[24]=i(" Encryption not enabled for this account. "))])),!((P=s.encStatus)!=null&&P.acntEncSetup)&&((U=s.encStatus)!=null&&U.acntEncSupported)?(o(),r("div",me,[a(l,{icon:"exclamation-triangle"}),e[35]||(e[35]=i(" Your user has not been granted account encryption access. This is required to encrypt and decrypt some types of data. Ask an account admin to grant you access by visiting their encryption settings. "))])):s.usersNotSetup&&s.usersNotSetup.length>0&&((h=s.encStatus)!=null&&h.acntEncSupported)?(o(),r("div",ce,[e[43]||(e[43]=t("div",{class:"larger"}," [Action Required] Encryption setup not complete for all users ",-1)),s.usersReadyForKey&&s.usersReadyForKey.length>0?(o(),r("div",ve,[e[37]||(e[37]=t("hr",null,null,-1)),a(v,{class:"mt-3",variant:"primary",onClick:e[8]||(e[8]=n=>s.shareAccountKey())},{default:p(()=>e[36]||(e[36]=[i("Share account key with other account users (recommended)")])),_:1}),e[38]||(e[38]=t("br",null,null,-1)),e[39]||(e[39]=t("br",null,null,-1)),e[40]||(e[40]=i(" Not all users have access to the account key. Click here to share the account key with all account users. ")),e[41]||(e[41]=t("br",null,null,-1)),e[42]||(e[42]=t("div",{class:"my-2"}," NOTE: A user must have a password and encryption enabled to receive the account key. ",-1))])):d("",!0)])):d("",!0),!s.loading&&s.userEncStatusList&&((C=s.encStatus)!=null&&C.acntEncSupported)&&((K=s.encStatus)!=null&&K.acntEncSetup)?(o(),r("div",we,[e[50]||(e[50]=t("h5",{class:"mb-3"},"Account User's Encryption Status",-1)),e[51]||(e[51]=t("hr",null,null,-1)),(o(!0),r(J,null,W(s.userEncStatusList,(n,B)=>(o(),r("div",{key:n._id,class:"mb-3"},[B>0?(o(),r("hr",ge)):d("",!0),t("div",null,[t("div",ke,[s.currentUserId!=n._id&&n.type!="admin"?(o(),m(N,{key:0,to:`/manage/user/${n._id}/encryption`,class:"linklike"},{default:p(()=>[i(c(n.username),1)]),_:2},1032,["to"])):(o(),r("div",fe,c(n.username)+" "+c(n._id==s.currentUserId?"[you]":""),1))]),t("div",be,c(n.type),1)]),t("div",Se,[t("div",null,[n.encStatus.hasPassword?(o(),m(l,{key:0,icon:"check-circle-fill",style:{color:"green"}})):(o(),m(l,{key:1,icon:"x-circle-fill",style:{color:"red"}})),e[44]||(e[44]=i(" Password Created "))]),t("div",null,[n.encStatus.userEncSetup?(o(),m(l,{key:0,icon:"check-circle-fill",style:{color:"green"}})):(o(),m(l,{key:1,icon:"x-circle-fill",style:{color:"red"}})),e[45]||(e[45]=i(" Encryption Setup "))]),t("div",null,[n.encStatus.acntEncSetup?(o(),m(l,{key:0,icon:"check-circle-fill",style:{color:"green"}})):(o(),m(l,{key:1,icon:"x-circle-fill",style:{color:"red"}})),e[46]||(e[46]=i(" Account Key Access "))])]),t("div",Ee,[n.type!="admin"&&s.currentUserId!=n._id&&(!n.encStatus.hasPassword||!n.encStatus.userEncSetup)?(o(),m(v,{key:0,size:"sm",variant:"primary",to:`/manage/user/${n._id}/encryption`},{default:p(()=>e[47]||(e[47]=[i(" Fix ")])),_:2},1032,["to"])):s.currentUserId!=n._id&&n.encStatus.hasPassword&&n.encStatus.userEncSetup&&!n.encStatus.acntEncSetup?(o(),r("div",Pe,[a(l,{icon:"exclamation-triangle"}),i(" Action required by admin user"+c(s.isAdminUser?" (you are an admin)":"")+": Share account key with user ",1)])):n.type=="admin"&&s.currentUserId!=n._id&&(!n.encStatus.hasPassword||!n.encStatus.userEncSetup)?(o(),r("div",Ue,[a(l,{icon:"exclamation-triangle"}),e[48]||(e[48]=i(" Action required by this user: User must enable encryption. "))])):d("",!0),s.currentUserId==n._id&&!n.encStatus.userEncEnabled?(o(),r("div",he,[a(l,{icon:"exclamation-triangle"}),e[49]||(e[49]=i(" Action required by you: Encryption Disabled - password or recovery key needed "))])):d("",!0),s.developerMode?(o(),r("div",Ce,c(n.encStatus.userEncEnabled),1)):d("",!0)])]))),128))])):d("",!0),s.loading?(o(),r("div",Ke,[a(M,{label:"Loading...",variant:"primary"})])):d("",!0),s.encStatus?(o(),m(q,{key:s.childComponentKey,onUpdated:e[9]||(e[9]=n=>s.loadPage())})):d("",!0)]}),_:1})]),_:1})]),s.developerMode?(o(),r("div",Re,[t("pre",null,c(s.encStatus),1)])):d("",!0)])}const Ge=Y(X,[["render",Ve]]);export{Ge as default};
