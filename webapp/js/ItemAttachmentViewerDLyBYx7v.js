import{I as P}from"./ItemImageBounipmB.js";import{a as W,p as M,av as H,_ as N}from"./components.global5n24RCIC.js";import{p as z}from"./textrenderD9QqXPpv.js";import{d as q,j as n,k as a,N as h,K as c,s as d,p as m,m as u,z as S,F as J,P as E,r as y,i,Q as G}from"./@vueC3Nhqlrl.js";const K=q({name:"ItemAttachmentViewer",mixins:[W],components:{ItemImage:P},props:{item:{type:Object,required:!0},isPub:{type:Boolean,default:!1},isFS:{type:Boolean,default:!1},fsButton:{type:Boolean,default:!1}},data(){return{attachments:null,selectedAttachment:null}},mounted(){},computed:{attachmentButtons(){return this.attachments?this.attachments.length<=7?this.attachments:[this.attachments[0],{isPlaceHolder:!0},this.attachments[this.attachments.length-1]]:[]},imageContainerClass(){return this.isFS?"itemViewContainerFS  fade-in-fast":"itemViewContainer  fade-in-fast"},hasAttachments(){return this.attachments&&this.attachments.length>0}},methods:{parseMarkdown:z,prettyTimePast:M,async itemClick(){this.isFS&&await this.rotateAttachment("next")},async rotateAttachment(e){if(!this.attachments||this.attachments.length==0){this.isFS&&this.$emit("close");return}let t=this.attachments.findIndex(o=>{var l;return o.id==((l=this.selectedAttachment)==null?void 0:l.id)});if(t==-1){t=0,await this.selectAttachment(this.attachments[t]);return}if(e=="next"){if(t++,t>=this.attachments.length){await this.selectAttachment(null);return}}else if(t--,t<0){await this.selectAttachment(null);return}await this.selectAttachment(this.attachments[t])},async getFileDataURL(e){if(!this.currentUserId)return;let t=await this.getFile(e.fileId);return H(t,e.fileType||"application/octet-stream")},async selectAttachment(e){if(!e){this.selectedAttachment=null;return}if(e.type=="file")if(e.fileType.startsWith("obj"))if(e.fileData)this.selectedAttachment=e;else{let t=await this.getFile(e.fileId,!0);t&&t.length<1e6&&(e.fileData=JSON.parse(t)),this.selectedAttachment={...e,fileData:t}}else if(e.fileDataURL)this.selectedAttachment=e;else{let t=await this.getFileDataURL(e);t&&t.length<1e6&&(e.fileDataURL=t),this.selectedAttachment={...e,fileDataURL:t}}},async getUserFileById(e,t=!1){return(await this.apiReq("/client/userfile/getById",{id:e},{excludePrefix:t})).result},async getPubFile(e){return(await this.apiReq("/pubFile/get",{pubId:this.item._id,filename:e})).result},async getFile(e,t=!1){try{return this.isPub?await this.getPubFile(e):await this.getUserFileById(e,t)}catch(o){return console.error(o),null}},async loadAttachments(){var t,o;this.attachments=[];const e=["video","image","obj"];if((o=(t=this.item)==null?void 0:t.attachments)!=null&&o.entries)for(let l of this.item.attachments.entries)e.includes(l.fileType.split("/")[0])&&(l.fileType.startsWith("image")&&this.getFileDataURL(l).then(f=>{l.fileDataURL=f}),l.fileType.startsWith("obj")&&this.getFile(l.fileId,!0).then(f=>{l.fileData=JSON.parse(f)}),this.attachments.push(l))},async loadData(){await this.loadAttachments()}},created(){this.loadData()}}),Q={class:"d-flex align-items-center justify-content-center itemHoverContainer"},X=["src"],Y=["src"],Z=["src"],x={key:3},_=["src"],ee={class:"centeredIconOverlay"},te={class:"danger-color rounded"},ie={key:0,class:"mt-2 mb-3 white-color"},se=["innerHTML"],ne={key:3},ae={key:1,class:"p-2 noteTextBoxFS"},le=["innerHTML"],re={class:"d-flex justify-content-center flex-gap-xs"},oe={key:0,class:"d-flex"},de=["onClick"],ce={key:0};function me(e,t,o,l,f,he){var v,g,k,A,w,C,b,I,D,F,T,U;const r=y("b-icon"),V=y("b-link"),j=y("b-button"),O=y("ItemImage");return i(),n("div",null,[a("div",Q,[e.hasAttachments&&e.currentUserId?(i(),n("div",{key:0,role:"button",class:"hoverItemOverlayLeft",onClick:t[0]||(t[0]=h(s=>e.rotateAttachment("prev"),["stop"]))},[c(r,{icon:"chevron-left",class:"hoverItemOverlayIcon"})])):d("",!0),e.hasAttachments&&e.currentUserId?(i(),n("div",{key:1,role:"button",class:"hoverItemOverlayRight",onClick:t[1]||(t[1]=h(s=>e.rotateAttachment("next"),["stop"]))},[c(r,{icon:"arrow-right",class:"hoverItemOverlayIcon"})])):d("",!0),e.selectedAttachment&&e.currentUserId?(i(),n("div",{key:2,onClick:t[4]||(t[4]=(...s)=>e.itemClick&&e.itemClick(...s))},[e.selectedAttachment.fileType.startsWith("video")?(i(),n("div",{key:0,class:m(e.imageContainerClass)},[a("video",{onClick:t[2]||(t[2]=h(()=>{},["stop"])),src:e.selectedAttachment.fileDataURL,controls:"",autoplay:"",class:"itemView"},null,8,X)],2)):e.selectedAttachment.fileType.startsWith("image/svg+xml")?(i(),n("div",{key:1,class:m(e.imageContainerClass)},[a("img",{src:e.selectedAttachment.fileDataURL,class:"itemViewSVG"},null,8,Y)],2)):e.selectedAttachment.fileType.startsWith("image")?(i(),n("div",{key:2,class:m(e.imageContainerClass)},[a("img",{src:e.selectedAttachment.fileDataURL,class:"itemView"},null,8,Z)],2)):e.selectedAttachment.fileType.startsWith("obj/youtube")?(i(),n("div",x,[a("div",{class:m(e.imageContainerClass)},[e.selectedAttachment.fileType=="obj/youtube"&&((g=(v=e.selectedAttachment)==null?void 0:v.fileData)!=null&&g.youtubeId)?(i(),u(V,{key:0,onClick:t[3]||(t[3]=h(()=>{},["stop"])),class:"iconOverlayContainer",href:`https://www.youtube.com/watch?v=${(A=(k=e.selectedAttachment)==null?void 0:k.fileData)==null?void 0:A.youtubeId}`,target:"_blank",rel:"noopener noreferrer"},{default:S(()=>{var s,p;return[a("img",{class:"rounded itemView",src:`https://img.youtube.com/vi/${(p=(s=e.selectedAttachment)==null?void 0:s.fileData)==null?void 0:p.youtubeId}/0.jpg`},null,8,_),a("div",ee,[a("div",null,[a("div",te,[c(r,{class:"bg-white py-0 shadow px-2 rounded",icon:"youtube"})])])])]}),_:1},8,["href"])):d("",!0)],2),e.isFS&&((C=(w=e.selectedAttachment)==null?void 0:w.fileData)!=null&&C.caption)?(i(),n("div",ie,[a("div",{class:"noteTextBox p-3",innerHTML:e.parseMarkdown((I=(b=e.selectedAttachment)==null?void 0:b.fileData)==null?void 0:I.caption)},null,8,se)])):d("",!0)])):d("",!0)])):e.selectedAttachment&&!e.currentUserId?(i(),n("div",ne,[a("div",{class:m(e.imageContainerClass)},[a("div",null,[c(j,{variant:"primary",href:e.appPrefix},{default:S(()=>t[10]||(t[10]=[G("Sign-In to view content")])),_:1},8,["href"])])],2)])):(i(),n("div",{key:4,class:m([e.imageContainerClass,"d-flex flex-gap-1 flex-wrap"]),onClick:t[5]||(t[5]=(...s)=>e.itemClick&&e.itemClick(...s))},[e.item&&(e.item.defaultImage||e.item.imageUrl)?(i(),u(O,{key:0,"icon-size":(e.isFS,2),item:e.item,alt:"",class:"itemView"},null,8,["icon-size","item"])):d("",!0),e.isFS&&((F=(D=e.item)==null?void 0:D.info)!=null&&F.value)?(i(),n("div",ae,[a("div",{class:"noteTextBox p-3",innerHTML:e.parseMarkdown((U=(T=e.item)==null?void 0:T.info)==null?void 0:U.value)},null,8,le)])):d("",!0)],2))]),e.attachments&&e.attachments.length>0?(i(),n("div",{key:0,class:m(["d-flex align-items-center justify-content-center",e.isFS?"fixed-to-bottom":"mt-3 "])},[a("div",re,[a("div",{role:"button",class:"py-1 px-2 hoverrow rounded",onClick:t[6]||(t[6]=h(s=>e.selectAttachment(null),["stop"]))},[c(r,{icon:"record"+(e.selectedAttachment?"":"-fill"),variant:"primary"},null,8,["icon"])]),(i(!0),n(J,null,E(e.attachmentButtons,(s,p)=>{var L,B,R;return i(),n("div",{key:p},[s.isPlaceHolder?(i(),n("div",oe,[a("div",{class:"py-1 px-2 hoverrow rounded",role:"button",onClick:t[7]||(t[7]=$=>e.rotateAttachment("prev"))},[c(r,{icon:"chevron-left",variant:"primary"})]),a("div",{class:"py-1 px-2 hoverrow rounded",role:"button",onClick:t[8]||(t[8]=$=>e.rotateAttachment("next"))},[c(r,{icon:"chevron-right",variant:"primary"})])])):(i(),n("div",{key:1,role:"button",onClick:h($=>e.selectAttachment(s),["stop"]),class:"py-1 px-2 hoverrow rounded"},[s.fileType.startsWith("image")?(i(),u(r,{key:0,icon:"record"+(((L=e.selectedAttachment)==null?void 0:L.id)==s.id?"-fill":""),variant:"primary"},null,8,["icon"])):s.fileType.startsWith("video")?(i(),u(r,{key:1,icon:"play"+(((B=e.selectedAttachment)==null?void 0:B.id)==s.id?"-fill":""),variant:"primary"},null,8,["icon"])):(i(),u(r,{key:2,icon:"record"+(((R=e.selectedAttachment)==null?void 0:R.id)==s.id?"-fill":""),variant:"primary"},null,8,["icon"]))],8,de))])}),128))]),e.fsButton?(i(),n("div",ce,[c(r,{icon:"arrows-fullscreen",variant:"primary",onClick:t[9]||(t[9]=s=>e.$emit("fs")),class:"ms-2"})])):d("",!0)],2)):d("",!0)])}const ve=N(K,[["render",me]]);export{ve as I};
