import{V as _}from"./ViewPostCbsXH6TF.js";import{V as R}from"./ViewFeedItemDo2uvm_5.js";import{a as P,_ as L}from"./components.globalBic2x0kT.js";import{P as M}from"./PlaceholderListDgoFc2vF.js";import{d as N,j as o,l,F as c,P as k,m as n,z as h,s as r,K as D,Q as m,r as d,i as a,p as E}from"./@vueC3Nhqlrl.js";const I=N({name:"MyFeed",mixins:[P],components:{PlaceholderList:M,ViewFeedItem:R,ViewPost:_},props:{perPage:{type:Number,default:10},asComponent:{type:Boolean,default:!1},maxAgeInDays:{type:Number,default:0}},data(){return{errorMessage:null,loadingFeed:!0,loadingNotifications:!0,feeds:[],currentPage:0,perPageInc:this.perPage,hasMore:!1,notifications:[]}},mounted(){},computed:{isLoading(){return this.loadingFeed||this.loadingNotifications},feedList(){if(!this.feeds||!this.notifications)return[];if(this.loadingFeed||this.loadingNotifications)return[];let e=[...this.feeds,...this.notifications];if(this.maxAgeInDays>0){const t=new Date;t.setDate(t.getDate()-this.maxAgeInDays),e=e.filter(s=>new Date(s.feedEntry.createdAt)>t||!s.feedEntry.isRead)}return e.sort((t,s)=>new Date(s.feedEntry.createdAt).getTime()-new Date(t.feedEntry.createdAt).getTime()),e.slice(0,this.perPage)}},methods:{loadMore(){this.currentPage+=1,this.loadFeed(!0)},removeItem(e){e.refType=="notification"?this.notifications=this.notifications.filter(t=>t._id!=e._id):this.feeds=this.feeds.filter(t=>t._id!=e._id)},clearNotifications(){this.sendReq("/user/notification/clear").then(()=>{this.loadFeed(),this.RefreshStats()})},convertToFeedItem(e){return{_id:e._id,refType:"notification",data:e.data,feedEntry:{_id:e._id,isRead:e.readAt!=null,createdAt:e.createdAt,feedInfo:{itemData:e.data}}}},async _loadNotifications(){const e=await this.sendReq("/user/notification/list",{},{needAuth:!0});this.notifications=e.result.filter(t=>t.type=="NEW_COMMENT").map(t=>this.convertToFeedItem(t)),this.loadingNotifications=!1},async _loadFeedItems(e=!1){const t=await this.sendReq("/client/feed/list",{pageInfo:{currentPage:this.currentPage,perPage:this.perPage+1,includeTotalRows:!1},includeComments:!0});if(t.success){const s=t.result.records;s.length>this.perPage?(this.hasMore=!0,s.pop()):this.hasMore=!1,e||(this.feeds=[]),this.feeds.push(...s),this.errorMessage=null}this.loadingFeed=!1},async loadFeed(e=!1){await this._loadNotifications(),await this._loadFeedItems(e),this.updateReadStatusForMultiple()},async updateReadStatusForMultiple(){await this._updateReadStatusForMultiplePosts(),await this._updateReadStatusForMultipleNotifications(),await this.RefreshStats()},async _updateReadStatusForMultiplePosts(){const e=this.feedList.filter(t=>{var s;return!((s=t==null?void 0:t.feedEntry)!=null&&s.isRead)&&t.refType=="post"}).map(t=>t._id);e.length!=0&&await this.sendReq("/feed/updateReadStatusForMultipleEntries",{ids:e,isRead:!0})},async _updateReadStatusForMultipleNotifications(){const e=this.feedList.filter(t=>{var s;return!((s=t==null?void 0:t.feedEntry)!=null&&s.isRead)&&t.refType=="notification"}).map(t=>t._id);e.length!=0&&await this.sendReq("/user/notification/markRead",{ids:e})}},watch:{},created(){this.loadFeed(),this.RefreshIndexQuick()}}),T={key:1,class:"text-center tsFadeInAnimationMed px-2"},A={key:2,class:"ms-3 my-2 text-muted"};function C(e,t,s,S,b,V){const y=d("ViewPost"),f=d("ViewFeedItem"),g=d("b-button"),F=d("b-col"),w=d("PlaceholderList");return a(),o("div",null,[l(e.$slots,"header",{feedList:e.feedList}),(a(!0),o(c,null,k(e.feedList,(i,u)=>(a(),o("div",{key:u,class:E(["t-post mb-2",u<e.feedList.length-1?"border-bottom":""])},[i.refType=="post"&&i.data?(a(),n(y,{key:0,post:i.data,feedEntry:i.feedEntry,onUpdate:t[0]||(t[0]=p=>e.loadFeed())},null,8,["post","feedEntry"])):i.refType=="sharedItem"?(a(),n(f,{key:1,onDismissed:p=>e.removeItem(i),feedItem:i},null,8,["onDismissed","feedItem"])):i.refType=="notification"?(a(),n(f,{key:2,onDismissed:p=>e.removeItem(i),feedItem:i},null,8,["onDismissed","feedItem"])):r("",!0)],2))),128)),e.asComponent?r("",!0):(a(),n(F,{key:0,class:"d-flex justify-content-center"},{default:h(()=>[e.hasMore?(a(),n(g,{key:0,variant:"primary",class:"my-5",onClick:t[1]||(t[1]=i=>e.loadMore())},{default:h(()=>t[2]||(t[2]=[m(" Load more ")])),_:1})):r("",!0)]),_:1})),e.isLoading?(a(),o("div",T,[D(w,{size:"lg"})])):r("",!0),!e.isLoading&&e.feedList.length==0?(a(),o("div",A,[e.asComponent?l(e.$slots,"noitems",{key:1}):(a(),o(c,{key:0},[m(" No posts to show. ")],64))])):r("",!0),l(e.$slots,"footer",{feedList:e.feedList})])}const j=L(I,[["render",C]]);export{j as S};
