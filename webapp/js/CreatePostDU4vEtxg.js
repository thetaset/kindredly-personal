import{_ as P,L as T,l as F,aC as E,aE as A,a as W,aq as N,aG as j,x as H,n as K}from"./components.globalSAVxUKYX.js";import{j as a,K as o,z as r,k as s,F as x,P as V,r as l,i,X as O,R as f,d as U,L as $,M as Q,N as G,s as u,Q as v,m as I,ac as X}from"./@vueC3Nhqlrl.js";import{S as J}from"./SelectImageCSiQCnFM.js";import{I as Y}from"./ItemImageB4O-XpFn.js";import Z from"./AddItemDVLAD9ud.js";import{P as ee}from"./TIIconDefaultBACySpee.js";import{S as te}from"./SelectUsersCsK2sfhZ.js";import{E as se}from"./EmojiPickerDsX8Vpds.js";import{a as oe}from"./item.storeCE3z3Z6A.js";import"./vue3-toastifyDll2FbVh.js";import"./@capacitorCjBcbZvA.js";import"./bootstrap-vue-nextDnMzdrWQ.js";import"./PopCollectionSelectorBo26MlBL.js";import"./CreateCollectionC2CAQQ8x.js";import"./ai_lookup_utilszDX_hcwM.js";import"./CollectionButtonListCK1eTpTV.js";import"./ItemTypesLjCsMI_T.js";import"./AddItemFromLibraryResultsDW-vejij.js";import"./@iconifyDLzQZ07j.js";import"./@iconify-iconsCsSCFVIT.js";const ie={name:"LibrarySearch",components:{LibraryIcon:T},data(){return{loading:!1,searchText:null,searchResults:[]}},mounted(){},computed:{},methods:{async runSearch(){this.loading=!0;try{const e=await this.sendReq("/client/searchMain",{searchType:"text",searchLookupValue:this.searchText});e.success&&e.result?(this.searchResults=F(e.result,60,!1),this.errorMessage=null):(console.error("Error:",e?e.message:"Unknown"),this.errorMessage=e.message)}catch(e){console.error(e)}finally{this.loading=!1}},async selectItem(e){this.$emit("select-item",e)}},created(){},components:{LibraryIcon:T}},ae={class:"mt-4"},ne={class:"my-2 mx-2"},le={key:0,class:"d-flex align-items-center"},re=["src"],de={class:"ms-2"},ce=["title"],me={key:1,class:"d-flex align-items-center"},ue={class:"ms-2"};function he(e,t,d,m,p,b){const y=l("BFormInput"),h=l("b-icon"),g=l("b-button"),w=l("b-input-group");return i(),a("div",null,[o(w,{class:"ms-2 mt-1"},{default:r(()=>[o(y,{modelValue:p.searchText,"onUpdate:modelValue":t[0]||(t[0]=c=>p.searchText=c),placeholder:"Search Library",onKeyup:t[1]||(t[1]=O(c=>b.runSearch(),["enter"])),autofocus:""},null,8,["modelValue"]),o(g,{class:"ms-2",disabled:p.loading,onClick:t[2]||(t[2]=c=>b.runSearch()),variant:"outline-secondary"},{default:r(()=>[o(h,{icon:"search"})]),_:1},8,["disabled"])]),_:1}),s("div",ae,[(i(!0),a(x,null,V(p.searchResults,(c,D)=>(i(),a("div",{key:D,class:"d-flex mt-2"},[s("div",ne,[o(g,{size:"sm",title:"Select",variant:"outline-primary",onClick:L=>b.selectItem(c)},{default:r(()=>[o(h,{icon:"plus"})]),_:2},1032,["onClick"])]),c.type=="link"?(i(),a("div",le,[s("div",null,[s("img",{height:"32",src:c.imageFilename},null,8,re)]),s("div",de,[s("div",{class:"text-muted small",title:c.url},f(e.textTruncate(c.url,50)),9,ce),s("div",null,f(e.textTruncate(c.name,40)),1)])])):(i(),a("div",me,[t[4]||(t[4]=s("div",null,[s("svg",{xmlns:"http://www.w3.org/2000/svg",height:"32",fill:"currentColor",class:"bi bi-folder",viewBox:"0 0 16 16"},[s("path",{d:"M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4H2.19zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z"})])],-1)),s("div",ue,[t[3]||(t[3]=s("div",null,"Collection",-1)),s("div",null,f(c.name),1)])])),t[5]||(t[5]=s("hr",{class:"my-1"},null,-1))]))),128))])])}const pe=P(ie,[["render",he]]),fe=U({name:"SelectVideo",props:{maxFileSizeMB:{type:Number,default:40},smallImageSize:{type:Number,default:400},keepPrefix:{type:Boolean,default:!1},description:{type:String,default:"Select a video"}},data(){return{video:null,screenshot:null,loading:!1,errorMessage:null}},mounted(){},computed:{},methods:{close(){this.$emit("close")},async selectVideo(e){try{this.errorMessage=null;const t=e.target.files[0];this.video=await E(t),this.screenshot=await A(this.video)}catch(t){console.error(t),this.errorMessage=t}this.loading=!1},async saveVideo(){if(!this.video||this.loading){console.error("Video not specified");return}let e=this.video.split(":")[1].split(";")[0],t=e.split("/")[1];if(t!=="mp4"&&t!=="webm"){this.errorMessage="Invalid file type. Only mp4 and webm files are allowed";return}let d=this.screenshot.split(";")[0].split(":")[1].split("/")[1];if(this.keepPrefix)this.$emit("select-data",{fileData:this.video,fileType:e,imagePreview:this.screenshot,imageType:d});else{const m=this.video.replace(/^data:video\/(mp4|webm);base64,/,""),p=this.screenshot.split(";base64,")[1];this.$emit("select-data",{fileData:m,fileType:e,imagePreview:p,imageType:d})}this.$emit("close")}},created(){}}),ge={ref:"canvas",style:{display:"none"}},ve={class:"m-4 text-center"},ye=["src"],_e={key:0},ke={key:0,class:"text-muted"},be={key:1,class:"text-muted"},Ie={class:"mt-4"},we={class:"d-flex justify-content-between mt-4"},$e={key:0,class:"my-4"};function Se(e,t,d,m,p,b){const y=l("b-spinner"),h=l("b-form-group"),g=l("b-button"),w=l("b-alert");return i(),a("div",null,[s("canvas",ge,null,512),s("div",ve,[$(s("div",null,[s("video",{onClick:t[0]||(t[0]=G(()=>{},["stop"])),ref:"videoViewer",src:e.video,controls:"",class:"imagePreview rounded"},null,8,ye),t[2]||(t[2]=s("hr",null,null,-1))],512),[[Q,!!e.video]]),e.video?u("",!0):(i(),a("div",_e,[e.loading?(i(),a("div",ke,[o(y)])):(i(),a("div",be,"No Video Selected"))]))]),s("div",Ie,[o(h,{class:"form-group"},{default:r(()=>[s("input",{class:"form-control",type:"file",onChange:t[1]||(t[1]=(...c)=>e.selectVideo&&e.selectVideo(...c)),accept:"video/mp4, video/webm"},null,32)]),_:1}),s("div",we,[o(g,{variant:"outline-secondary",onClick:e.close},{default:r(()=>t[3]||(t[3]=[v(" Cancel")])),_:1},8,["onClick"]),o(g,{class:"ms-auto",onClick:e.saveVideo,variant:"outline-primary",disabled:e.loading},{default:r(()=>[v(f(e.loading?"Loading...":"Select"),1)]),_:1},8,["onClick","disabled"])])]),e.errorMessage?(i(),a("div",$e,[o(w,{variant:"danger","model-value":!0},{default:r(()=>[v(f(e.errorMessage),1)]),_:1})])):u("",!0)])}const Ce=P(fe,[["render",Se]]),Pe=U({name:"ItemInfoRow",components:{ItemImage:Y},props:{item:{type:Object,required:!0},quickPost:{type:Boolean,default:!1}},data(){return{}},mounted(){},computed:{},methods:{},created(){}}),De={key:0},Me={key:0,class:"d-flex align-items-center flex-gap-sm mb-1"},Te=["title"];function xe(e,t,d,m,p,b){const y=l("ItemImage"),h=l("b-icon");return i(),a("div",null,[e.item?(i(),a("div",De,[e.quickPost?u("",!0):(i(),a("div",Me,[o(y,{class:"rounded",width:80,item:e.item},null,8,["item"]),s("button",{class:"btn btn-link",onClick:t[0]||(t[0]=g=>e.$emit("remove"))},[o(h,{icon:"x"})])])),s("div",{class:"wtruncate",title:e.item.name||e.item.url},f(e.textTruncate(e.item.name||e.item.url,60)),9,Te)])):u("",!0)])}const Ve=P(Pe,[["render",xe]]);function Ue(e){if(!e)return[];const t=/(https?:\/\/[^\s]+)/g;return e.match(t)||[]}const Le=U({name:"CreatePost",mixins:[W],modalMixin:N,emits:["close"],props:{itemIds:{type:Array,default:()=>[]},quickPost:{type:Boolean,default:!1}},components:{ProfileImage:ee,LibraryIcon:T,LibrarySearch:pe,SelectImage:J,ItemInfoRow:Ve,AddItem:Z,SelectUsers:te,EmojiPicker:se,SelectVideo:Ce},data(){return{postType:null,postData:{text:null},showPicker:!1,sharedWith:[],errorMessage:null,loading:!1,friends:void 0,shareWithText:"",attachedItems:[]}},mounted(){},computed:{selectedUserList(){return this.userList.filter(e=>this.sharedWith.includes(e._id)&&e._id!==this.currentUserId)},userList(){return!this.users||!this.friends?[]:[...this.users,...this.friends].sort((t,d)=>t.username<d.username?-1:t.username>d.username?1:0)}},methods:{imageDataToBase64URL:j,async cancel(){this.errorMessage=null,this.$emit("close",null)},updateUsers(e){this.sharedWith=e,this.closeModal("select-users-modal")},async removeUser(e){this.sharedWith=this.sharedWith.filter(t=>t!==e)},async createPost(){this.loading=!0;try{if(this.errorMessage=null,(this.postData.text===null||this.postData.text==="")&&this.attachedItems.length===0){this.errorMessage="Post is empty.",this.loading=!1;return}const e=Ue(this.postData.text);for(const d of e){let{itemId:m}=await oe(d,null,{type:"post"});await this.attachItem(m)}this.sharedWith.push(this.currentUserId);const t=await this.sendReq("/client/post/create",{postType:this.postType,data:this.postData,sharedWith:this.sharedWith,attachedItems:[...this.attachedItems]});if(t.success){H(),this.errorMessage=null;const d=t.result;try{this.$emit("close",t==null?void 0:t.result)}catch(m){console.error("Error:",m)}this.$router.push("/p/"+d)}else console.error("Error:",t.message),this.showToast("An error occured while trying to create the post.",{variant:"danger",title:"Error",solid:!0});this.RefreshIndexQuick()}catch(e){console.error("Error:",e),this.showToast("An error occured while trying to create the post.",{variant:"danger",title:"Error",solid:!0})}finally{this.loading=!1}},selectEmoji(e){e&&(this.postData.text=(this.postData.text||"")+e),this.showPicker=!1},async removeItem(e){this.attachedItems=this.attachedItems.filter(t=>t.id!==e)},async attachItem(e){if(!e)return;const t=await this.sendReq("/client/item/info",{itemId:e});if(t.success){const d=t.result,m=K(d);this.attachedItems.push({id:this.attachedItems.length,type:"libItem",data:m,itemId:m._id}),this.closeModal("search-library-modal")}else console.error("Error:",t.message),this.showToast(t.message,{variant:"danger",title:"Error",solid:!0})},async attachImageData(e){this.attachedItems.push({id:this.attachedItems.length,type:"imageFile",data:e}),this.closeModal("select-image-modal")},async attachVideo(e){this.attachedItems.push({id:this.attachedItems.length,type:"videoFile",data:e}),this.closeModal("select-video-modal")},async loadFriends(){if(this.isCustomServer)return;this.loading=!0;const e=await this.sendReq("/user/friend/list",{});e.success?(this.friends=e.result.friends,this.errorMessage=null):(console.error("Error:",e.message),this.errorMessage=e.message),this.loading=!1},async importAttachments(){if(this.itemIds.length>0)for(const e of this.itemIds)await this.attachItem(e);if(this.tempShareData&&this.tempShareData.length>0)for(const e of this.tempShareData)e.data.mimeType.includes("image")?await this.attachImageData(e.preppedData):e.data.mimeType.includes("video")&&await this.attachVideo(e.preppedData)}},created(){this.loadFriends(),this.importAttachments(),this.quickPost&&this.showModal("select-users-modal")}}),Re={class:"d-flex justify-content-center align-items-center"},Be={class:"d-flex justify-content-between flex-wrap flex-gap-1"},qe={class:"mt-2"},ze={class:"d-flex me-2"},Fe={class:"mt-2"},Ee={key:0,class:"d-flex align-items-center mt-1"},Ae={key:1,class:"d-flex align-items-center mt-1"},We=["src"],Ne=["onClick"],je={key:2,class:"d-flex align-items-center mt-1"},He=["src"],Ke=["onClick"],Oe={key:3,class:"d-flex align-items-center mt-1"},Qe=["src"],Ge=["onClick"],Xe={class:"mt-2"},Je={class:"d-flex justify-content-end"},Ye={class:"mt-2"},Ze={key:0,class:"text-muted"},et={class:"my-2"},tt={class:"d-flex justify-content-between mt-5"},st={key:0};function ot(e,t,d,m,p,b){const y=l("SelectImage"),h=l("b-modal"),g=l("SelectVideo"),w=l("AddItem"),c=l("SelectUsers"),D=l("b-form-textarea"),L=l("b-form-group"),_=l("b-icon"),k=l("b-button"),R=l("ItemInfoRow"),B=l("ProfileImage"),q=l("b-alert"),z=l("b-spinner"),S=X("b-modal");return i(),a("div",null,[o(h,{lazy:"true",id:"select-image-modal",title:"Select Image",size:"lg","hide-footer":"","no-close-on-backdrop":""},{default:r(()=>[o(y,{onSelectImageData:e.attachImageData,"max-size":1400,keepAspectRatio:!0,keepPrefix:!0,onClose:t[0]||(t[0]=n=>e.closeModal("select-image-modal"))},null,8,["onSelectImageData"])]),_:1}),o(h,{lazy:"true",id:"select-video-modal",title:"Select Video",size:"lg","hide-footer":"","no-close-on-backdrop":""},{default:r(()=>[o(g,{onSelectData:e.attachVideo,keepPrefix:!0,maxFileSizeMB:40,onClose:t[1]||(t[1]=n=>e.closeModal("select-video-modal"))},{default:r(()=>t[3]||(t[3]=[v(" >")])),_:1},8,["onSelectData"])]),_:1}),o(h,{lazy:"true",id:"search-library-modal",title:"Search for item in Library",size:"lg","no-close-on-backdrop":"","hide-footer":""},{default:r(()=>[o(w,{onClose:e.attachItem,allowExisting:!0,excludeAllCollections:!0},null,8,["onClose"])]),_:1}),o(h,{lazy:"true",id:"select-users-modal",title:"Select Users","hide-footer":""},{default:r(()=>[o(c,{userIds:e.sharedWith,onUpdate:e.updateUsers},null,8,["userIds","onUpdate"])]),_:1}),s("div",null,[s("div",Re,[o(L,{class:"form-group w-100"},{default:r(()=>[o(D,{class:"",modelValue:e.postData.text,"onUpdate:modelValue":t[2]||(t[2]=n=>e.postData.text=n),placeholder:"What would you like to say? (optional)",rows:"3"},null,8,["modelValue"])]),_:1})]),s("div",Be,[s("div",qe,[s("div",ze,[e.quickPost?u("",!0):$((i(),I(k,{key:0,variant:"link"},{default:r(()=>[o(_,{icon:"plus-lg"})]),_:1})),[[S,void 0,void 0,{"search-library-modal":!0}]]),e.quickPost?u("",!0):$((i(),I(k,{key:1,variant:"link",class:"me-2"},{default:r(()=>[o(_,{icon:"image"})]),_:1})),[[S,void 0,void 0,{"select-image-modal":!0}]]),e.quickPost?u("",!0):$((i(),I(k,{key:2,variant:"link",class:"me-2"},{default:r(()=>[o(_,{icon:"play-circle-fill"})]),_:1})),[[S,void 0,void 0,{"select-video-modal":!0}]])]),s("div",Fe,[(i(!0),a(x,null,V(e.attachedItems,(n,M)=>(i(),a("div",{key:M},[n.type=="libItem"?(i(),a("div",Ee,[o(R,{quickPost:e.quickPost,item:n.data,onRemove:C=>e.removeItem(n.id)},null,8,["quickPost","item","onRemove"])])):n.type=="image"?(i(),a("div",Ae,[s("img",{src:e.imageDataToBase64URL(n.data),alt:"",style:{"max-width":"100px","max-height":"100px"},class:"rounded"},null,8,We),s("button",{class:"btn btn-link ms-2",onClick:C=>e.removeItem(n.id)},[o(_,{icon:"x"})],8,Ne)])):n.type=="imageFile"?(i(),a("div",je,[s("img",{src:e.imageDataToBase64URL(n.data.imagePreview),alt:"",class:"rounded",style:{"max-width":"100px","max-height":"100px"}},null,8,He),e.quickPost?u("",!0):(i(),a("button",{key:0,class:"btn btn-link ms-2",onClick:C=>e.removeItem(n.id)},[o(_,{icon:"x"})],8,Ke))])):n.type=="videoFile"?(i(),a("div",Oe,[s("img",{src:e.imageDataToBase64URL(n.data.imagePreview),alt:"",class:"rounded",style:{"max-width":"100px","max-height":"100px"}},null,8,Qe),e.quickPost?u("",!0):(i(),a("button",{key:0,class:"btn btn-link ms-2",onClick:C=>e.removeItem(n.id)},[o(_,{icon:"x"})],8,Ge))])):u("",!0)]))),128))])]),s("div",Xe,[s("div",Je,[$((i(),I(k,{variant:"outline-primary",class:"fixedWidthButton"},{default:r(()=>[o(_,{class:"larger",icon:"person-plus"}),t[4]||(t[4]=v(" Select Users "))]),_:1})),[[S,void 0,void 0,{"select-users-modal":!0}]])]),s("div",Ye,[e.selectedUserList.length===0?(i(),a("div",Ze," No users selected ")):u("",!0),(i(!0),a(x,null,V(e.selectedUserList,(n,M)=>(i(),a("div",{key:M,class:"ms-auto mb-1"},[o(k,{variant:"link",class:"fixedWidthButton fillrow border bw-color",onClick:C=>e.removeUser(n._id),title:"click to remove"},{default:r(()=>[o(B,{profileImage:n.profileImage,width:24},null,8,["profileImage"]),v(" "+f(n.displayedName||n.username)+" "+f(n.displayedName?` (${n.username})`:""),1)]),_:2},1032,["onClick"])]))),128))])])]),s("div",et,[e.errorMessage?(i(),I(q,{key:0,variant:"danger","model-value":!!e.errorMessage},{default:r(()=>[v(f(e.errorMessage),1)]),_:1},8,["model-value"])):u("",!0)]),s("div",tt,[o(k,{variant:"outline-secondary",onClick:e.cancel},{default:r(()=>t[5]||(t[5]=[v("Cancel")])),_:1},8,["onClick"]),o(k,{variant:"primary",onClick:e.createPost,disabled:e.loading},{default:r(()=>[e.loading?(i(),I(z,{key:1,small:""})):(i(),a("span",st,"Post "))]),_:1},8,["onClick","disabled"])])])])}const $t=P(Le,[["render",ot],["__scopeId","data-v-adc271bc"]]);export{$t as default};
