import{a as B,aj as D,t as q,l as V,ap as _,x as M,_ as F}from"./components.globalBic2x0kT.js";import{C as R}from"./CollectionButtonListBeQ7-vfj.js";import{I as $}from"./ItemTypesCr9cej62.js";import z from"./PopCollectionSelectorCwff-9C9.js";import{S as N,U as j}from"./UploadAttachmentsToAddDMredDwu.js";import{I as E}from"./ItemImagelPteIRA_.js";import{c as K,s as O}from"./item.storeDRTqnxm_.js";import{d as Q,j as m,K as l,z as c,k as o,F as W,P as G,s as u,L as k,m as I,r as i,ac as H,i as n,Q as y,R as J,p as X}from"./@vueC3Nhqlrl.js";import"./vue3-toastifyDll2FbVh.js";import"./@capacitorCjBcbZvA.js";import"./bootstrap-vue-nextDnMzdrWQ.js";import"./CreateCollectionDxlS16jr.js";import"./TIIconDefaultCMdnLD-P.js";import"./ai_lookup_utilszDX_hcwM.js";import"./upload.mixinCdGnd8mT.js";const Y=Q({name:"AddItemDefault",mixins:[B],components:{PopCollectionSelector:z,CollectionButtonList:R,ItemTypes:$,ItemImage:E,ShareItemList:N,UploadAttachmentsToAdd:j},props:{userId:{type:String,required:!1},targetUserId:{type:String,required:!1},collectionIds:{type:Array,required:!1,default:()=>[]},itemType:{type:String,required:!1,default:null},itemSubType:{type:String,required:!1,default:null}},data(){return{loading:!1,errorMessage:null,page:null,permissionLookup:{},collections:null,createdItemId:null,createdItemInfo:null,selectedCollectionIds:[],selectedCollections:[],sharedWithUserIds:[],currentCollectionIds:[],details:{_id:void 0,url:null,name:null,description:null,tags:null,patterns:null,type:"link",subType:null},textContent:null,needConfirm:!1,pages:[{text:"Item Info",value:"new"},{text:"Collections",value:"collections"}]}},mounted(){},computed:{pageList(){const e=[];for(const t of this.pages)if(e.push(t),t.value==this.page)break;return e},collectionOptions(){const e=[];if(this.collections==null||this.collections.length==0)return e;let t=this.collections;for(const s of t){const a=s.path?"/"+s.path.join("/"):"";e.push({text:s.name,value:s._id,path:a,sortKey:a+" "+s.name})}return e.sort(function(s,a){return D(s,a,"sortKey")}),e}},methods:{textTruncate:q,async selectCollections(){this.collectionIds&&this.collectionIds.length>0&&(await this.addSelectedCollection(this.collectionIds),await this.loadSelectedCollections())},async addSelectedCollection(e){for(const t of e)this.selectedCollectionIds.includes(t)||this.selectedCollectionIds.push(t)},async updateItemType(e){this.details.type=e.type,this.details.subType=e.subType},async saveItem(){var a;this.loading=!0,this.details.tags==null&&(this.details.tags="");const e={...this.details};e.tags=this.details.tags.split(",").map(function(d){return d.toLowerCase().trim()}),this.itemType=="thing"&&(e.type="thing",e.subType=this.details.subType);const t=[...this.currentCollectionIds,...this.selectedCollectionIds];this.textContent&&(e.info={value:this.textContent});const s=await this.sendReq("/client/item/save",{itemId:e._id,details:e,collectionIds:t,tempAuthToken:((a=this.permissionOverrideInfo)==null?void 0:a.tokenData)||null});if(s.success){const d=s.result;this.createdItemId=d,this.createdItemInfo=await K({itemId:d}),this.tempShareData&&this.tempShareData.length>0&&await this.uploadTempShareItems(),this.RefreshIndexQuick(),this.$emit("close",d),this.errorMessage=null}else console.error("Error:",s.message),this.errorMessage=s.message,this.showToast(s.message,{variant:"danger"}),this.loading=!1},loadCollections(){this.sendReq("/client/collection/listByUser",{userId:this.userId,includePath:!0}).then(e=>{this.collections=V(e.result)})},loadUserPermissions(){this.errorMessage=null,this.sendReq("/item/userPermissionLookup",{userId:this.userId}).then(e=>{e.success?this.permissionLookup=e.result:(console.error("Error:",e.message),this.errorMessage=e.message),this.loadCollections()})},removeCollection(e){this.selectedCollectionIds=this.selectedCollectionIds.filter(t=>t!=e),this.loadSelectedCollections()},addCollection(e){if(!e){this.closeModal("select-col-modal");return}this.selectedCollectionIds.push(e),this.loadSelectedCollections(),this.closeModal("select-col-modal")},async doneAddingFiles(){this.closeModal("addFile"),await _()},async loadSelectedCollections(){if(this.errorMessage="",!this.selectedCollectionIds||this.selectedCollectionIds.length==0){this.selectedCollections=[];return}const e=await this.sendReq("/client/collection/listByAccount",{ids:this.selectedCollectionIds,includePath:!0,includeUserPermissions:!0});if(!e.success){this.errorMessage=e.message,console.error(this.errorMessage);return}this.selectedCollections=e.result.sort(function(t,s){return D(t,s,"name")})},closeMe(){this.clearPermissionOverrideInfo(),this.$emit("close",!1)},async uploadTempShareItems(){let e=!0;for(const t of this.tempShareData)await this.uploadItem(t,e),e=!1;M()},async uploadItem(e,t=!1){var p,g;let s=e.data.mimeType,a=e.data.filename,d=e.data.size,C="data:"+e.data.mimeType+";base64",v=e.preppedData.fileData,f={type:"file",filename:a,urlPrefix:C,filesize:d,fileType:s,fileData:v,imagePreview:(p=e.preppedData)==null?void 0:p.imagePreview,imageType:(g=e.preppedData)==null?void 0:g.imageType};const h=await this.sendReq("/client/item/attachment/add",{itemId:this.createdItemId,attachmentInfo:f,encInfo:this.createdItemInfo.details.encInfo});return h.success?(t&&e.preppedData.imagePreview&&await O(C+","+e.preppedData.imagePreview,this.createdItemId,this.createdItemInfo.details.encInfo),!0):(console.error("upload failed"),this.showToast(h.message,{variant:"danger"}),!1)}},created(){this.page="new",this.details.subType=this.itemSubType,this.details.subType||(this.details.subType="file_group"),this.targetUserId&&this.sharedWithUserIds.push(this.targetUserId),this.loadUserPermissions(),this.selectCollections()}}),Z={key:0,class:"d-flex align-items-center pb-2"},ee={key:1},te={class:"rounded border py-1 px-2"},se={class:"mt-2 d-flex flex-gap-sm align-items-center"},le={key:2,class:"ani-fade-in-fast"},oe={key:0,class:"mb-3"},ie={key:1,class:"text-muted mt-3"},ne={class:"d-flex justify-content-right mt-2"};function ae(e,t,s,a,d,C){const v=i("UploadAttachmentsToAdd"),f=i("b-modal"),h=i("PopCollectionSelector"),p=i("b-icon"),g=i("ShareItemList"),b=i("b-button"),U=i("ItemTypes"),S=i("b-form-textarea"),T=i("b-form-group"),A=i("b-form-input"),L=i("CollectionButtonList"),P=i("b-spinner"),w=H("b-modal");return n(),m("div",null,[l(f,{title:"Select File(s)",id:"addFile","hide-footer":""},{default:c(()=>[l(v,{onUpdate:t[0]||(t[0]=r=>e.doneAddingFiles())})]),_:1}),l(f,{lazy:"true",id:"select-col-modal",title:"Select Collection",size:"lg","hide-footer":""},{default:c(()=>[l(h,{onClose:e.addCollection},null,8,["onClose"])]),_:1}),t[16]||(t[16]=o("div",null,null,-1)),e.itemType!="thing"?(n(),m("div",Z,[(n(!0),m(W,null,G(e.pageList,(r,x)=>(n(),m("div",null,[o("div",{class:X(["me-2",{"text-muted":e.page!=r.value}])},[y(J(r.text)+" ",1),x<e.pageList.length-1?(n(),I(p,{key:0,icon:"chevron-right"})):u("",!0)],2)]))),256))])):u("",!0),e.tempShareData&&e.tempShareData.length>0?(n(),m("div",ee,[t[5]||(t[5]=o("div",{class:"mb-2 text-muted-extra"},"Attachments",-1)),o("div",te,[l(g)])])):u("",!0),o("div",se,[k((n(),I(b,{variant:"secondary"},{default:c(()=>[l(p,{icon:"file-plus-fill",class:"me-1"}),t[6]||(t[6]=y(" Select File(s)"))]),_:1})),[[w,void 0,void 0,{addFile:!0}]]),t[7]||(t[7]=o("div",{class:"small text-muted"},"(optional)",-1))]),e.page=="new"?(n(),m("div",le,[t[11]||(t[11]=o("div",{class:"mt-3"},null,-1)),e.itemType=="thing"&&e.details?(n(),m("div",oe,[t[8]||(t[8]=o("div",{class:"mb-2 text-muted-extra"},"Item Type",-1)),l(U,{itemType:"thing",itemSubType:e.details.subType,onUpdate:e.updateItemType,disableButtons:!0},null,8,["itemSubType","onUpdate"])])):u("",!0),l(T,{class:"form-group"},{default:c(()=>[l(S,{id:"formName",modelValue:e.details.name,"onUpdate:modelValue":t[1]||(t[1]=r=>e.details.name=r),required:"",rows:"1","max-rows":"6",placeholder:"Name"},null,8,["modelValue"])]),_:1}),l(T,{class:"form-group"},{default:c(()=>[l(S,{id:"formComment",modelValue:e.textContent,"onUpdate:modelValue":t[2]||(t[2]=r=>e.textContent=r),required:"",rows:"3","max-rows":"6",placeholder:"Text Content (optional)"},null,8,["modelValue"])]),_:1}),l(T,{class:"form-group"},{default:c(()=>[l(A,{id:"formTags",autocorrect:"off",autocapitalize:"off",modelValue:e.details.tags,"onUpdate:modelValue":t[3]||(t[3]=r=>e.details.tags=r),placeholder:"Enter Tags seperated by commas. (optional)",required:""},null,8,["modelValue"])]),_:1}),t[12]||(t[12]=o("div",{class:"my-3"},null,-1)),t[13]||(t[13]=o("div",{class:"mb-3 text-muted-extra"},"Select Collections",-1)),k((n(),I(b,{variant:"outline-secondary"},{default:c(()=>t[9]||(t[9]=[y("Add to Collection")])),_:1})),[[w,void 0,void 0,{"select-col-modal":!0}]]),t[14]||(t[14]=o("div",{class:"my-2"},null,-1)),e.selectedCollections.length==0?(n(),m("div",ie," No collections selected ")):u("",!0),l(L,{collections:e.selectedCollections,onSelect:e.removeCollection},null,8,["collections","onSelect"]),t[15]||(t[15]=o("div",{class:"my-4"},null,-1)),o("div",ne,[l(b,{class:"ms-auto",variant:"primary",onClick:t[4]||(t[4]=r=>e.saveItem()),disabled:e.loading},{default:c(()=>[e.loading?(n(),I(P,{key:0,small:"",label:"Loading..."})):u("",!0),t[10]||(t[10]=y(" Save"))]),_:1},8,["disabled"])])])):u("",!0),t[17]||(t[17]=o("div",{class:"bottom-gap-mobile"},null,-1))])}const Se=F(Y,[["render",ae]]);export{Se as default};
