import{a as P,_ as C}from"./components.globalSAVxUKYX.js";import{P as $}from"./TIIconDefaultBACySpee.js";import{d as A,j as n,k as t,K as o,Q as d,F as g,P as k,m as I,z as l,s as a,R as u,r as c,i as r,L as O,U as T}from"./@vueC3Nhqlrl.js";const E=A({name:"ItemPermissions",components:{ProfileImage:$},mixins:[P],props:{itemId:{type:String,required:!0}},data(){return{perms:[],selectedUser:null,permission:"editor",targetUserId:null,owner:null,page:"main",hasInheritedPermission:!1,options:[{text:"Viewer",value:"viewer"},{text:"Editor",value:"editor"},{text:"Remove Access",value:null}]}},mounted(){},computed:{availableOptions(){return this.options.filter(s=>!this.hasInheritedPermission||s.value!=null)},numRestrictedUsersWithAccess(){return this.perms.filter(s=>s.user.type=="restricted"&&!!s.permission).length},numRestrictedEditors(){return this.perms.filter(s=>s.user.type=="restricted"&&s.permission=="editor").length},notOwners(){return this.owner==null?[]:[...this.users||[]].filter(e=>e._id!=this.owner.userId)},notInLibrary(){return[...this.users||[]].filter(e=>this.isAdminUser||e.type=="admin").filter(e=>!this.perms.find(v=>v.userId==e._id))},inLibrary(){if(!this.owner)return[];const s=this.perms.filter(e=>e.permission!="owner");return[this.owner,...s]},hasEditPerm(){return this.permission=="editor"||this.permission=="owner"}},methods:{async loadPermissions(){const s=await this.sendReq("/item/permissions/list",{itemId:this.itemId});if(!s.success){this.showToast("Error loading permissions",{title:"Error",variant:"danger",solid:!0});return}this.perms=s.result,this.owner=this.perms.find(e=>e.permission=="owner")},addUser(s,e=!1){this.permission="editor",this.selectedUser=s,this.targetUserId=s._id,this.hasInheritedPermission=e,this.page="edit"},editUser(s){if(this.hasInheritedPermission=!1,!this.isAdminUser){this.showToast("You do not have permission to edit permissions",{title:"Error",variant:"danger",solid:!0});return}this.permission=s.permission,this.selectedUser=s,this.targetUserId=s._id,this.page="edit"},backToMain(){this.selectedUser=null,this.targetUserId=null,this.permission=null,this.hasInheritedPermission=!1,this.page="main"},async addUserAs(s,e){this.permission=e,this.selectedUser=s,this.targetUserId=s._id,this.updatePermissions(!1)},async updatePermissions(s=!0){if(!this.targetUserId)return;const e={userId:this.targetUserId,permission:this.permission};(await this.sendReq("/item/updatePermissions",{itemId:this.itemId,permissionUpdates:[e]})).success?(this.loadPermissions(),this.$emit("update"),this.showToast("Permission change complete",{title:"Success",variant:"success",solid:!0}),s&&this.backToMain()):(this.showToast("Failed to change permission",{title:"Failed",variant:"danger",solid:!0}),this.hasInheritedPermission=!1)},async transferOwnership(){this.sendReq("/item/transferOwnership",{userId:this.targetUserId,itemId:this.itemId}).then(s=>{this.loadPermissions(),this.backToMain(),this.$emit("update")})}},created(){this.loadPermissions()}}),N={key:0},R={key:0},L={class:"container"},S={class:"row"},V={class:"col"},j={class:"my-2 small border rounded p-2 fillrow"},B={class:"col d-flex align-items-center flex-gap-1"},M={key:0,class:"text-muted small"},x={class:"col-3 d-flex align-items-center justify-content-end"},q={key:0},D={key:0},F=["onClick"],z={key:1,title:"This permission was inherited from a parent collection ",class:"ms-1"},W=["onClick"],H={key:1},K={class:"row mt-4"},Q={class:"col"},Y={key:1,class:"text-muted"},G={key:2,class:"flex-gap-sm mt-3 d-flex alert alert-danger"},J={key:1},X={key:1},Z=["value"],ee={key:1},se={class:"d-flex flex-wrap justify-content-between mt-3"},ie={key:2},te={key:0},re={class:"d-flex justify-content-center align-items-center flex-gap-1 flex-wrap my-4"},ne={class:"mt-1"},oe={key:0,class:"font-weight-bold"},de={key:1},ae={class:"d-flex flex-gap-1 justify-content-center mt-2 mb-3"},le={key:1},me={class:"d-flex flex-wrap justify-content-between mt-5"},ue={key:3},pe={key:0,class:"ms-2"},he={class:"d-flex flex-wrap mb-2"},ce={class:"d-flex flex-wrap mb-2"},fe={key:1,class:"mt-2 small text-muted"},ve={class:"d-flex flex-wrap justify-content-between mt-5"};function ge(s,e,v,ke,we,ye){const p=c("b-icon"),w=c("ProfileImage"),m=c("b-button"),U=c("b-form-group"),_=c("b-form-radio-group");return r(),n("div",null,[s.page=="main"?(r(),n("div",N,[s.inLibrary.length>0?(r(),n("div",R,[t("div",L,[t("div",S,[t("div",V,[t("div",j,[o(p,{icon:"info-circle",class:"me-2"}),e[7]||(e[7]=d(" User's below have this item in their library with the listed permission. "))])])]),(r(!0),n(g,null,k(s.inLibrary,(i,h)=>{var f,y;return r(),n("div",{class:"row px-2 py-3 rounded hoverrow border my-3",key:h},[t("div",B,[o(w,{profileImage:i.user.profileImage,width:40},null,8,["profileImage"]),t("div",null,[t("div",null,u(((f=i==null?void 0:i.user)==null?void 0:f.displayedName)||i.username),1),(y=i==null?void 0:i.user)!=null&&y.displayedName?(r(),n("div",M,u(i.username),1)):a("",!0)])]),t("div",x,[t("div",null,u(i.permission),1),i.permissionDetails.direct?(r(),n("div",q,[s.isAdminUser?(r(),n("div",D,[i.permission!="owner"?(r(),n("button",{key:0,class:"btn btn-link ms-1",onClick:b=>s.editUser(i.user),title:"Edit permission"},[o(p,{icon:"pencil"})],8,F)):(r(),n("button",{key:1,class:"btn btn-link ms-1",onClick:e[0]||(e[0]=b=>s.page="changeOwner")},[o(p,{icon:"pencil"})]))])):a("",!0)])):(r(),n("div",z,[s.isAdminUser&&i.permission!="owner"?(r(),n("div",{key:0,role:"button",onClick:b=>s.addUser(i.user,!0),title:"Edit permission",class:"linklike"}," (inherited) ",8,W)):(r(),n("div",H,"(inherited)"))]))])])}),128)),t("div",K,[t("div",Q,[s.hasEditPerm?(r(),I(m,{key:0,variant:"primary",onClick:e[1]||(e[1]=i=>s.page="add")},{default:l(()=>e[8]||(e[8]=[d("+ Add user")])),_:1})):(r(),n("div",Y,[o(p,{icon:"lock"}),e[9]||(e[9]=d(" Restricted user's can only give admins access and cannot modify permissions. "))])),s.isAdminUser&&s.numRestrictedEditors>0&&s.numRestrictedUsersWithAccess>1?(r(),n("div",G,[o(p,{icon:"exclamation-triangle"}),e[10]||(e[10]=t("div",null," Having restricted users with edit access to a collection that contains other restricted users is not recommended. This would allow a restricted user to share content with other restricted users that they might not have access to. ",-1))])):a("",!0)])])])])):(r(),n("div",J,e[11]||(e[11]=[t("div",{class:"mt-2 mb-1"},"No users have access to this library.",-1)])))])):a("",!0),s.page=="changeOwner"?(r(),n("div",X,[e[15]||(e[15]=t("div",{class:"my-2"},"Select an owner",-1)),e[16]||(e[16]=t("div",{class:"d-flex flex-wrap mb-2"},null,-1)),s.notOwners&&s.notOwners.length>0?(r(),I(U,{key:0,class:"form-group"},{default:l(()=>[O(t("select",{"onUpdate:modelValue":e[2]||(e[2]=i=>s.targetUserId=i),class:"form-control"},[(r(!0),n(g,null,k(s.notOwners,(i,h)=>(r(),n("option",{key:h,value:i._id},u(i.displayedName||i.username)+" "+u(i.displayedName?`(${i.username})`:""),9,Z))),128))],512),[[T,s.targetUserId]])]),_:1})):(r(),n("div",ee,e[12]||(e[12]=[t("div",{class:"mb-4"},"No other users found.",-1)]))),t("div",se,[o(m,{variant:"secondary",onClick:s.backToMain},{default:l(()=>e[13]||(e[13]=[d("Back")])),_:1},8,["onClick"]),o(m,{variant:"primary",onClick:e[3]||(e[3]=i=>s.transferOwnership())},{default:l(()=>e[14]||(e[14]=[d("Save")])),_:1})])])):a("",!0),s.page=="add"?(r(),n("div",ie,[t("div",null,[s.notInLibrary.length>0?(r(),n("div",te,[e[21]||(e[21]=t("label",null,"Select a user",-1)),t("div",re,[(r(!0),n(g,null,k(s.notInLibrary,(i,h)=>(r(),n("div",{style:{width:"200px",height:"200px"},key:h,class:"d-flex justify-content-center flex-column rounded align-items-center border"},[o(w,{profileImage:i.profileImage,width:50,showCircle:!1},null,8,["profileImage"]),t("div",ne,[i._id==s.currentUserId?(r(),n("span",oe,e[17]||(e[17]=[t("b",null,"you",-1)]))):(r(),n("span",de,u(i.username),1))]),e[20]||(e[20]=t("div",{class:"text-muted small mt-3"},"Select a permission",-1)),t("div",ae,[o(m,{variant:"primary",size:"sm","data-test-id":`add-user-as-viewer_${i.username}`,onClick:f=>s.addUserAs(i,"viewer")},{default:l(()=>e[18]||(e[18]=[d(" viewer")])),_:2},1032,["data-test-id","onClick"]),o(m,{variant:"primary",size:"sm","data-test-id":`add-user-as-editor_${i.username}`,onClick:f=>s.addUserAs(i,"editor")},{default:l(()=>e[19]||(e[19]=[d(" editor")])),_:2},1032,["data-test-id","onClick"])])]))),128))])])):a("",!0),s.notInLibrary.length==0?(r(),n("div",le," All users have access to this library. ")):a("",!0)]),t("div",me,[o(m,{variant:"secondary",onClick:e[4]||(e[4]=i=>s.page="main"),"data-test-id":"user-perm-back"},{default:l(()=>e[22]||(e[22]=[d("Back")])),_:1}),e[23]||(e[23]=t("div",null,null,-1))])])):a("",!0),s.page=="edit"?(r(),n("div",ue,[s.selectedUser?(r(),n("div",pe,[t("div",he,[e[24]||(e[24]=t("div",{class:"me-1 text-muted"},"Choose permission for",-1)),t("b",null,u(s.selectedUser.username),1)]),t("div",ce,[o(_,{modelValue:s.permission,"onUpdate:modelValue":e[5]||(e[5]=i=>s.permission=i),options:s.availableOptions,name:"radio-permission",stacked:""},null,8,["modelValue","options"])])])):a("",!0),s.hasInheritedPermission?(r(),n("div",fe,[o(p,{icon:"info-circle",class:"me-1"}),e[25]||(e[25]=d(" User has inherited permission from a parent collection. "))])):a("",!0),t("div",ve,[o(m,{variant:"secondary",onClick:s.backToMain},{default:l(()=>e[26]||(e[26]=[d("Back")])),_:1},8,["onClick"]),o(m,{variant:"primary",onClick:e[6]||(e[6]=i=>s.updatePermissions())},{default:l(()=>e[27]||(e[27]=[d("Save")])),_:1})])])):a("",!0),e[28]||(e[28]=t("div",{class:"bottom-gap-mobile"},null,-1))])}const _e=C(E,[["render",ge],["__scopeId","data-v-2cd16dd8"]]);export{_e as I};
