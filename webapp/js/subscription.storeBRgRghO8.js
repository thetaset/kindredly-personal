import{g as o,Q as p,q as b,r as g,d as S,f as z,a4 as J,n as Q,J as N,at as V}from"./components.globalBic2x0kT.js";import{a2 as W}from"./@vueC3Nhqlrl.js";const r=W({followingLookup:void 0,subscriptionLookup:void 0,subGroupInfo:void 0,subSettingsInfo:void 0});async function h(){if(!o.currentUser())return!1;const e=await p("/following/listByUserId",{userId:o.currentUserId()});r.followingLookup=new Set(e.result.map(t=>t.refId))}async function $(e,t,n=void 0){if(!o.currentUser())return!1;r.followingLookup&&r.followingLookup.has(t)?await D(e,t,n):await X(e,t,n)}async function X(e,t,n){if(!o.currentUser())return!1;n=n||o.currentUserId(),await p("/following/add",{userId:n,refType:e,refId:t}),await h()}async function D(e,t,n=void 0){if(!o.currentUser())return!1;n=n||o.currentUserId(),await p("/following/remove",{userId:n,refType:e,refId:t}),await h()}async function m(){if(!o.currentUser())return!1;const e=await p("/client/subscription/listForUser",{userId:o.currentUserId()});r.subscriptionLookup=Object.fromEntries(e.result.map(t=>{var a;let n=t.refId;return(t.refType=="item_feed"||t.refType=="custom")&&(n=J((a=t==null?void 0:t.data)==null?void 0:a.feedURL)),[n,t]}).filter(t=>t[0]!=null))}async function Y(e,t,n=void 0){if(!o.currentUser())return!1;r.subscriptionLookup&&t in r.subscriptionLookup?await P(e,t,n):await ne(e,t,n)}function Z(e){return r.subscriptionLookup?e in r.subscriptionLookup:(m(),!1)}async function ee(e){return r.subscriptionLookup[e]}async function te(e){return r.subscriptionLookup||await m(),Object.fromEntries(e.map(t=>[t,r.subscriptionLookup[t]]))}async function ne(e,t,n){if(!o.currentUser())return!1;n=n||o.currentUserId(),await p("/subscription/add",{userId:n,refType:e,refId:t}),await m()}async function se(e,t,n,a=null){if(!o.currentUser())return!1;a=a||o.currentUserId();const s=await p("/client/subscription/add",{userId:a,refType:e,refId:t,data:n});return await m(),s.result}async function ae(e,t,n){await p("/client/subscription/edit",{subscriptionId:e,data:t,encInfo:n}),await m()}async function B(e,t=!1){if(!t){const s=await b("subscription_list");if(s!=null&&s.data)return s==null?void 0:s.data}const a=(await p("/client/subscription/listForUser",{userId:e})).result;return await g("subscription_list",a),a}async function re(e,t=!1){return(await B(e,t)).map(a=>ie(a))}function ie(e){var t,n,a,s;return e.refType=="custom"||e.refType=="item_feed"?{...e,...e.data,type:((t=e.data)==null?void 0:t.type)||((n=e.data)==null?void 0:n.sourceType),_id:e._id,data:e.data}:e.refType=="item_feed"?{...e,...e.data,type:((a=e.data)==null?void 0:a.type)||((s=e.data)==null?void 0:s.sourceType),_id:e._id,data:e.data,item:Q(e.item)}:e.refType=="pub_col"?{...e,title:e.data||e.item.name,description:e.item.description,type:e.refType,_id:e._id,data:e.data,item:N(e.item)}:{...e,title:e.data||e.item.name,description:e.item.description,type:e.refType,_id:e._id,data:e.data}}async function P(e,t,n=void 0){if(!o.currentUser())return!1;n=n||o.currentUserId(),await p("/subscription/remove",{userId:n,refType:e,refId:t}),await m()}async function oe(e){if(!o.currentUser())return!1;await p("/subscription/removeById",{subscriptionId:e}),await m()}async function H(e=!1){const t=await b("cache_subSettingsInfo");return!e&&(t!=null&&t.data)?r.subSettingsInfo={settings:t.data.settings,lastUpdate:t.data.lastUpdate}:(r.subSettingsInfo={settings:{},lastUpdate:new Date().getTime()},await g("cache_subSettingsInfo",r.subSettingsInfo)),r.subSettingsInfo.settings}async function ue(e={}){const t={settings:e,lastUpdate:new Date().getTime()};await g("cache_subSettingsInfo",t),r.subSettingsInfo=t}function ce(){var n,a;let e=((n=r.subGroupInfo)==null?void 0:n.groups)||[];return((a=r.subGroupInfo)==null?void 0:a.lastUpdate)==null&&v(),e}const le=1e3*60*60*24*1;async function pe(e,t){let n="cache_"+e;const a=await p("/user/prefs/update",{updates:{[e]:t}});if(!a.success){console.error(a.message);return}await g(n,t)}async function de(e,t=!1,n=le){let a="cache_"+e;const s=await b(a);console.log("Cache:",caches);const u=(s==null?void 0:s.timestamp)||0,y=new Date().getTime();let d=null;try{if(t||!(s!=null&&s.data)||u+n>y){const f=await p("/user/prefs/getValue",{key:e});f.result&&f.result.length>0&&(d=f.result[0].value)}else d=s==null?void 0:s.data}catch{d=null}return await g(a,d),d}async function v(e=!1){let t=await de("subGroupInfo",e);return console.log("pref",t),t!=null&&t.groups?r.subGroupInfo={groups:t==null?void 0:t.groups,lastUpdate:t==null?void 0:t.lastUpdate}:r.subGroupInfo={groups:[],lastUpdate:new Date().getTime()},r.subGroupInfo}async function fe(e=[]){const t={groups:e,lastUpdate:new Date().getTime()};await pe("subGroupInfo",{...t}),r.subGroupInfo=t}function me(){var n,a;let e=((n=r.subSettingsInfo)==null?void 0:n.settings)||{};return((a=r.subSettingsInfo)==null?void 0:a.lastUpdate)==null&&H(),e}async function ge(e,t){const n=await p("/client/fetch",{url:e,options:t});return n==null?void 0:n.result}async function K(e){return V()?await await ge(e,{method:"GET",headers:{Accept:"application/rss+xml, application/xml, text/xml","User-Agent":"Mozilla/5.0 (compatible; RSS Reader/1.0)"}}):(await p("/client/feedproxy",{url:e})).result}async function ye(e,t){var R,k;const a=new DOMParser().parseFromString(t,"text/xml");let s=(k=(R=a.querySelector("image"))==null?void 0:R.querySelector("url"))==null?void 0:k.textContent,u=a.lookupNamespaceURI("content"),y=a.lookupNamespaceURI("media"),d=a.lookupNamespaceURI("itunes");S("contentNamespace",u);let f=a.querySelectorAll("item");f.length==0&&(f=a.querySelectorAll("entry"));const U=new Set,_=[];return f.forEach(c=>{var F,A,G,q,I,x,E,M;const T=((F=c.querySelector("link"))==null?void 0:F.getAttribute("href"))||((A=c.querySelector("link"))==null?void 0:A.textContent);if(U.has(T))return;U.add(T);let w=(G=c.querySelector("description"))==null?void 0:G.textContent,l=(q=c.querySelector("thumbnail"))==null?void 0:q.getAttribute("url");if(!l&&d){const i=c.getElementsByTagNameNS(d,"image")[0];i&&(l=i.getAttribute("href"))}if(!l&&y){const i=c.getElementsByTagNameNS(y,"content")[0];i&&(l=i.getAttribute("url"))}if(!l){const i=c.getElementsByTagNameNS(u,"encoded")[0];if(S("contentEncoded",i),i){S("contentEncoded.innerHTML",i.innerHTML);const C=/<img.*?src=['"](.*?)['"]/.exec(i.innerHTML);C&&(l=C[1])}}if(!l&&w&&w.length>50){const L=/<img.*?src=['"](.*?)['"]/.exec(w);L&&(l=L[1])}if(!l){const i=c.querySelector("enclosure");i&&(l=i.getAttribute("url"))}const O=Array.from(c.getElementsByTagName("category")).map(i=>({term:i.getAttribute("term"),label:i.getAttribute("label")}));l=l||s;const j={title:(I=c.querySelector("title"))==null?void 0:I.textContent,type:"feed_item",url:T,description:w,createdAt:((x=c.querySelector("pubDate"))==null?void 0:x.innerHTML)||((E=c.querySelector("published"))==null?void 0:E.innerHTML)||((M=c.querySelector("updated"))==null?void 0:M.innerHTML),categories:O,imageUrl:l,defaultImage:l,all:c.innerHTML,subDetails:e};_.push(j)}),_}function we(e,t){return t=N(t),{...t,type:"pub_item",sourceId:t.refId,refId:t.refId,refType:t.refType,title:t.name,url:t.url,description:t.description,imageUrl:t.imageFilename,createdAt:t.createdAt,subDetails:e,data:t}}async function Ue(e,t=!1){var a;const n="sub_"+e._id;if(!t){const s=await b(n);if(s&&s.timestamp>new Date().getTime()-1e3*60*60)return S("Getting cached items"),e.itemsLastUpdated=s.timestamp,(a=s==null?void 0:s.data)==null?void 0:a.items}if(e.type=="rss"||e.type=="item_feed"){const s=await K(e.feedURL);console.log("feed content",{subscription:{...e},force:t,text:s},s);const u=await ye(e,s);return console.log("feedItems",u),e.itemsLastUpdated=new Date().getTime(),g(n,{items:u,itemsLastUpdated:e.itemsLastUpdated}),u}else if(e.type=="pub_col"){const s=await z("/published/collectionItemFeed",{itemId:e.refId});return s.success?s.result.map(u=>we(e,u)):(console.error(s.message),[])}return[]}const Te={subGroupList:()=>ce(),subSettings:()=>me()},Le={ToggleFollowing:$,RemoveFromFollowing:D,RefreshFollowing:h,ToggleSubscription:Y,RemoveFromSubscription:P,RefreshSubscriptions:m,ListAllSubscriptions:B,ListAllPreparedSubscriptions:re,EditSubscription:ae,createCustomSubscription:se,UpdateSubscriptionGroups:fe,FetchSubGroupList:v,UpdateSubSettings:ue,FetchSubSettings:H,isSubscription:Z,getSubscriptionByKey:ee,getSubscriptionsMap:te,RemoveFromSubscriptionById:oe,GetFeedFromURL:K};export{H as F,Ue as L,h as R,Y as T,ue as U,Le as a,v as b,se as c,Te as g,Z as i};
