import{a as B,U as c,_ as E}from"./components.globalDizx_NTC.js";import R from"./PopCollectionSelectorBW6dnAeB.js";import{I as V}from"./ItemImageDmIqiyLE.js";import{A as D}from"./CreateCollectionBbjx_AkR.js";import{p as k}from"./textrenderD2sqh9-p.js";import{d as N,r as n,i,j as d,L as b,M as y,k as s,K as o,z as m,p as A,s as p,Q as x,F as M,m as w,R as S}from"./@vueC3Nhqlrl.js";import"./vue3-toastifyDll2FbVh.js";import"./@capacitorCjBcbZvA.js";import"./bootstrap-vue-nextDnMzdrWQ.js";import"./TIIconDefaultB4jiNlod.js";import"./ai_lookup_utilszDX_hcwM.js";import"./markedJKvyS0Pp.js";function j(){let e=null;return function(t,r){clearTimeout(e),e=setTimeout(()=>{t()},r||500)}}const q=j(),L=N({name:"CreateOrEditNote",components:{PopCollectionSelector:R,ItemImage:V,AISuggester:D},emits:["close"],props:{itemId:{type:String,default:null},parentCollectionId:{type:String,default:null},defaultVisibility:{type:String,default:null}},mixins:[B],data(){return{loading:!0,showPreview:!1,draft:!1,item:null,name:null,value:void 0,editorReady:!1,errorMessage:null,parent:null,editor:null,editorType:"text",selectedParentCollectionId:null,selectedParentCollection:null,editorObj:null}},mounted(){},computed:{parsedText(){return k(this.value)},rows(){return this.value?Math.max(10,this.value.split(`
`).length+1):10}},methods:{parseMarkdown:k,textareaInputUpdate(e){this.saveInput(),this.resizeTextarea()},resizeTextarea(){},_saveInput(){c.set(this.currentUserId,"noteCache",{id:this.itemId,name:this.name,value:this.value}),this.draft=!0},saveInput(){q(()=>{this._saveInput()},50)},async loadSelectedCollection(){var t;this.errorMessage="";const e=await this.sendReq("/client/collection/listByAccount",{ids:[this.selectedParentCollectionId],includePath:!0,includeUserPermissions:!0});if(!e.success){this.errorMessage=e.message,console.error(this.errorMessage);return}this.selectedParentCollection=(t=e.result)==null?void 0:t[0]},addCollection(e){if(!e){this.closeModal("select-col-modal");return}this.selectedParentCollectionId=e,this.loadParentInfo(),this.closeModal("select-col-modal")},async loadParentInfo(){if(!this.selectedParentCollectionId)return;const e=await this.sendReq("/client/collection/infoByUser",{collectionId:this.selectedParentCollectionId,includeUserPermissions:!0});e.success?this.parent=e.result:(this.errorMessage=e.message,console.error(e.message))},async save(){var r;if(this.errorMessage=null,!this.name&&!this.value){this.errorMessage="Please enter a title or note";return}!this.name&&this.value&&(this.name=this.value.slice(0,40).replace(/\n/g," "));const e={name:this.name,info:{editor:"txt",value:this.value},encInfo:(r=this.item)==null?void 0:r.encInfo};let t;this.itemId?t=await this.sendReq("/client/item/update",{itemId:this.itemId,data:{...this.item,...e}}):(e.type="note",t=await this.sendReq("/client/item/save",{details:e,collectionIds:this.selectedParentCollectionId?[this.selectedParentCollectionId]:[]})),t.success?(this.RefreshIndexQuick(),c.clear(this.currentUserId,"noteCache").catch(u=>{console.error(u)}),this.$emit("close",t.result)):this.showToast(t.message,{variant:"danger",title:"Error",solid:!0})},async loadCurrentItem(){if(this.loading=!0,this.itemId){await this._loadItem();const e=await c.get(this.currentUserId,"noteCache");if(e&&(e==null?void 0:e.id)==this.itemId){this.name=e.name,this.value=e.value,this.draft=!0,this.loading=!1,this.$nextTick(()=>{this.resizeTextarea()});return}}else{const e=await c.get(this.currentUserId,"noteCache");e&&(e==null?void 0:e.id)==null&&(this.name=e.name,this.value=e.value,this.draft=!0),this.loading=!1,this.$nextTick(()=>{this.resizeTextarea()});return}this.loading=!1},async updateWithSuggestion(e){e&&(this.value=e.textContent,this.saveInput())},async _loadItem(){var t,r,u,f,v,h;const e=await this.sendReq("/client/item/info",{itemId:this.itemId,detailsOnly:!0});if(e.success){this.item=(t=e==null?void 0:e.result)==null?void 0:t.details,this.name=(r=this.item)==null?void 0:r.name,this.editorType=(f=(u=this.item)==null?void 0:u.info)==null?void 0:f.editor;const l=(h=(v=this.item)==null?void 0:v.info)==null?void 0:h.value;this.editorType=="editorjs"&&(l!=null&&l.blocks)?this.value=l==null?void 0:l.blocks.map(g=>g.data.text).join(`
`):this.value=l}else this.errorMessage=e.message,console.error(e.message)},async deleteDraft(){await this.confirmModal("Clear draft from memory and reset note?")&&(c.clear(this.currentUserId,"noteCache").catch(t=>{console.error(t)}),this.itemId?await this.loadCurrentItem():(this.name=null,this.value=null),this.draft=!1)},setupEditor(){}},created(){this.selectedParentCollectionId=this.parentCollectionId,this.loadParentInfo(),this.loadCurrentItem()}}),O={class:"flex-container-auto"},W={key:0,class:"mx-1 mb-2 ani-slide-down"},F=["innerHTML"],H={class:"d-flex flex-gap-1 justify-content-between mt-2"},Q={class:"mt-4 d-flex align-items-center"},K={key:0,class:"text-muted"},G={role:"button",class:"mb-3"},J={class:"miniItemImageContainer"},X={class:""},Y={key:1,class:"d-flex align-items-center flex-gap-sm"},Z={key:0,class:"my-2 alert alert-danger"},ee={class:"text-center my-2"};function te(e,t,r,u,f,v){const h=n("PopCollectionSelector"),l=n("b-modal"),g=n("b-form-input"),I=n("b-form-group"),T=n("b-form-textarea"),C=n("b-icon"),P=n("AISuggester"),U=n("ItemImage"),_=n("b-button"),$=n("b-button-toolbar"),z=n("b-spinner");return i(),d(M,null,[b(s("div",null,[o(l,{lazy:"true",id:"select-col-modal",title:"Select Parent Collection",size:"lg","hide-footer":""},{default:m(()=>[o(h,{onClose:e.addCollection},null,8,["onClose"])]),_:1}),o(I,{class:"form-group mt-2",description:""},{default:m(()=>[o(g,{id:"formTitle",modelValue:e.name,"onUpdate:modelValue":t[0]||(t[0]=a=>e.name=a),class:"trans-form-input larger",placeholder:"Title (optional) ","data-test-id":"noteTitle",onChange:e.saveInput},null,8,["modelValue","onChange"])]),_:1}),o(I,{class:"form-group mt-4"},{default:m(()=>[s("div",O,[o(T,{ref:"noteEditor",id:"noteEditorId",modelValue:e.value,"onUpdate:modelValue":t[1]||(t[1]=a=>e.value=a),rows:e.rows,placeholder:"Enter text...","data-test-id":"noteEditor",class:"auto-resize trans-form-input",onInput:e.textareaInputUpdate},null,8,["modelValue","rows","onInput"]),e.showPreview?(i(),d("div",W,[s("div",{class:A(["my-1 noteTextBox",(e.isMobile,"")]),ref:"noteTextBox",innerHTML:e.parsedText},null,10,F)])):p("",!0)]),s("div",H,[s("div",{role:"button",onClick:t[2]||(t[2]=a=>e.showPreview=!e.showPreview),class:"linklike-dl small pill px-2 py-0 border"},[o(C,{icon:e.showPreview?"eye-slash":"eye"},null,8,["icon"]),t[7]||(t[7]=x(" Markdown Preview "))]),e.isAdminUser?(i(),d(M,{key:0},[e.itemId?(i(),w(P,{key:0,customSuggest:"","valid-action-ids":["text_improve"],onUpdate:e.updateWithSuggestion,item:e.item},null,8,["onUpdate","item"])):(i(),w(P,{key:1,customSuggest:"","valid-action-ids":["text_improve"],onUpdate:e.updateWithSuggestion,"context-data":{name:e.name,textContent:e.value,type:"note"}},null,8,["onUpdate","context-data"]))],64)):p("",!0)])]),_:1}),s("div",null,[b(s("div",Q,[o(I,null,{default:m(()=>[e.parent?(i(),d("div",K,[s("div",G,[t[8]||(t[8]=s("div",{class:"mb-2"},[s("div",{class:"text-muted small"},"Parent Collection")],-1)),s("div",{class:"rounded border hoverrow p-2 d-flex flex-gap-sm align-items-center",onClick:t[3]||(t[3]=a=>e.showModal("select-col-modal")),role:"button"},[s("div",J,[(i(),w(U,{class:"rounded shadow-sm miniItemImageLg",item:e.parent,key:e.parent._id,alt:""},null,8,["item"]))]),s("div",X,S(e.parent.name),1)])])])):!e.parentCollectionId&&!e.itemId?(i(),d("div",Y,[s("div",{role:"button",onClick:t[4]||(t[4]=a=>e.showModal("select-col-modal")),class:"text-muted d-flex flex-gap-sm align-items-center border rounded p-1 px-2 fillrow"},[o(C,{icon:"collection",class:""}),t[9]||(t[9]=s("div",{class:"text-muted"},"Select Parent Collection",-1))]),t[10]||(t[10]=s("div",{class:"small text-muted"},"(optional)",-1))])):p("",!0)]),_:1})],512),[[y,!e.itemId]])]),e.errorMessage?(i(),d("div",Z,S(e.errorMessage),1)):p("",!0),o($,{class:"mt-4"},{default:m(()=>[e.draft?(i(),d("div",{key:0,class:"small px-2 align-items-center d-flex flex-gap-xs",onClick:t[5]||(t[5]=(...a)=>e.deleteDraft&&e.deleteDraft(...a)),role:"button"},[t[11]||(t[11]=s("div",{class:"d-flex"},"draft saved",-1)),o(C,{icon:"x"})])):p("",!0),o(_,{"data-test-id":"saveNoteButton",class:"ms-auto",variant:"primary",onClick:t[6]||(t[6]=a=>e.save())},{default:m(()=>t[12]||(t[12]=[x("Save")])),_:1})]),_:1}),t[13]||(t[13]=s("div",{class:"bottom-gap-mobile"},null,-1))],512),[[y,!e.loading]]),b(s("div",null,[s("div",ee,[o(z)])],512),[[y,e.loading]])],64)}const he=E(L,[["render",te]]);export{he as default};
