import{r as f,i as r,j as i,k as t,L as a,M as c,R as m,s as u,N as _,p as P,m as b,K as g,z as v,Q as S}from"./@vueC3Nhqlrl.js";import{_ as k}from"./components.globalDizx_NTC.js";import"./vue3-toastifyDll2FbVh.js";import"./@capacitorCjBcbZvA.js";import"./bootstrap-vue-nextDnMzdrWQ.js";const C={name:"Checkout",data(){return{selectedPlanId:null,selectedPlan:[],plans:null,loading:!0,storeConfig:{},subscriptionInfo:null,elements:null,errorMessage:null,section:"summary"}},async mounted(){this.includeStripe("js.stripe.com/v3/",(function(){this.configure()}).bind(this))},computed:{},methods:{includeStripe(e,n){let p=document,h="script",s=p.createElement(h),o=p.getElementsByTagName(h)[0];s.src="//"+e,n&&s.addEventListener("load",function(d){n(null,d)},!1),o.parentNode.insertBefore(s,o)},async configure(){if(this.selectedPlanId=localStorage.getItem("@selectedPlan"),await this.loadStoreConfig(),await this.loadPlans(),this.selectedPlan=this.plans.find(e=>e.planId==this.selectedPlanId),!this.selectedPlan){console.error("Plan not found"),this.errorMessage="Plan not found";return}this.loading=!1},async startPaymentRequest(){this.stripe=Stripe(this.storeConfig.stripPublishableKey);const e={theme:"stripe"};this.elements=this.stripe.elements({appearance:e,clientSecret:this.subscriptionInfo.clientSecret}),this.paymentElement=this.elements.create("payment"),this.paymentElement.mount("#payment-container")},async confirmPayment(){this.loading=!0,this.errorMessage=null;const{error:e}=await this.stripe.confirmPayment({elements:this.elements,confirmParams:{return_url:`${this.config.serverHostname}/order/complete`}});e&&(this.errorMessage=e.message),this.loading=!1},async createSubscription(){this.loading=!0;const e=await this.sendReq("/store/createSubscription",{planId:this.selectedPlanId,provider:"stripe"});e.success&&e.result?(this.subscriptionInfo=e.result,this.subscriptionInfo.paymentRequired?(this.startPaymentRequest(),this.section="collect_payment"):(this.section="done",await this.RefreshAccountInfo(!0,!0)),this.loading=!1):console.error("Error:",e)},async loadPlans(){const e=await this.sendReq("/plans/list");e.success?(this.plans=e.result,this.errorMessage=null):(console.error("Error:",e.message),this.errorMessage=e.message)},async loadStoreConfig(){const e=await this.sendReq("/store/config");e.success&&e.result?this.storeConfig=e.result:console.error("Error:",e)}},async created(){}},w={class:"mx-auto mt-4"},I={class:"cardo mx-auto text-center border rounded m-4 shadow p-4 mt-5"},x={class:"mx-auto"},M={key:0,class:"mb-5"},E={class:"ms-2 mt-4"},N={class:"larger mt-3"},R={key:0},q={key:1},B={class:"h-100"},D={class:"m-3"},T={class:"mt-2"},V={key:1},j={class:"mt-2 h4"},L={key:0,class:"mt-4 alert alert-danger",role:"alert"},z={key:0},K={key:0,class:"text-center mt-4"};function A(e,n,p,h,s,o){const d=f("b-spinner"),y=f("router-link");return r(),i("div",null,[t("div",w,[n[5]||(n[5]=t("div",{class:"text-center"},[t("div",{class:"h1"},"Plan Change")],-1)),t("div",I,[t("div",x,[a(t("div",null,[s.selectedPlan&&s.section!="done"?(r(),i("div",M,[t("div",E,[t("h3",null,m(s.selectedPlan.planName),1),t("div",N,[s.selectedPlan.cost?(r(),i("span",R," $"+m(s.selectedPlan.cost.USD)+" per "+m(s.selectedPlan.planData.freq),1)):(r(),i("span",q,"Free"))])])])):u("",!0),t("div",B,[t("div",D,[t("form",{onSubmit:n[0]||(n[0]=_((...l)=>o.confirmPayment&&o.confirmPayment(...l),["prevent"]))},n[3]||(n[3]=[t("div",{id:"payment-container"},null,-1)]),32),a(t("div",T,[a(t("button",{onClick:n[1]||(n[1]=(...l)=>o.createSubscription&&o.createSubscription(...l)),class:"btn btn-primary btn-lg mt-3"},"Confirm",512),[[c,s.section=="summary"]]),a(t("button",{onClick:n[2]||(n[2]=(...l)=>o.confirmPayment&&o.confirmPayment(...l)),class:P([{disabled:s.loading},"btn btn-primary btn-lg mt-4"])},[s.loading?(r(),b(d,{key:0,small:"",label:"..."})):(r(),i("span",V," Submit Payment "))],2),[[c,s.section=="collect_payment"]])],512),[[c,!s.loading]]),a(t("div",j,"Plan Change Successful",512),[[c,s.section=="done"&&!s.loading]]),s.errorMessage?(r(),i("div",L,m(s.errorMessage),1)):u("",!0)])])],512),[[c,!s.loading]]),s.loading?(r(),i("div",z,[g(d,{label:"Loading..."})])):u("",!0)])]),s.section!="done"?(r(),i("div",K,[g(y,{to:"/support"},{default:v(()=>n[4]||(n[4]=[S(" Cancel ")])),_:1})])):u("",!0)])])}const G=k(C,[["render",A]]);export{G as default};
