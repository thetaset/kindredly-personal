import{a as L,ah as A,U as v,ai as O,l as p,aj as N,_ as $}from"./components.globalBic2x0kT.js";import{C as R}from"./CreateCollectionDxlS16jr.js";import D from"./AddItemB3DBnDEa.js";import{T as x}from"./TIIconDefaultCMdnLD-P.js";import{I as q}from"./ItemListBk-h_1t6.js";import{d as F,r as u,i as o,j as n,k as h,p as b,m as f,z as d,Q as y,R as c,K as a,F as B,P as C,s as m,X as V}from"./@vueC3Nhqlrl.js";import"./vue3-toastifyDll2FbVh.js";import"./@capacitorCjBcbZvA.js";import"./bootstrap-vue-nextDnMzdrWQ.js";import"./ai_lookup_utilszDX_hcwM.js";import"./PopCollectionSelectorCwff-9C9.js";import"./ItemImagelPteIRA_.js";import"./CollectionButtonListBeQ7-vfj.js";import"./ItemTypesCr9cej62.js";import"./AddItemFromLibraryResultsCJPZQEW-.js";import"./browserTabsB3WsZHRs.js";import"./TIFeedbackInfoC6PM9-5H.js";import"../kindredapp.js";import"./vue-routerB6Jsgi62.js";import"./vue-plugin-load-scriptXwA-LyvJ.js";import"./bootstrapDQG5F40S.js";import"./@popperjsCCtJ9KiL.js";import"./@mozillaCDB2aYYy.js";import"./PlaceholderListDgoFc2vF.js";const j=F({mixins:[L],name:"UserCollections",components:{CreateCollection:R,AddItem:D,TIIconDefault:x,ItemList:q},data(){return{loading:!0,pageLoading:!0,showSearch:!1,createCollectionForm:{name:null,description:null,visibility:"private"},results:[],targetUserId:null,targetUser:null,loadAmountOptions:[20,40,60,80,100,0],errorMessage:void 0,filterName:"toplevel",searchText:void 0,fields:[{key:"name",label:"Collections",sortable:!1}],orderBy:"name",orderByOptions:[{value:"name",text:"Name"},{value:"recentlyAdded",text:"Date"}],ownedByMe:!1,ownedBy:"anyone",ownedByOptions:[{value:"anyone",text:"Anyone"},{value:"me",text:"Me"}],filterList:[]}},mounted(){},computed:{isAdminOfTargetUser(){var e;return this.isAdminUser&&((e=this.targetUser)==null?void 0:e.type)=="restricted"},isCurrentUser(){return!this.targetUserId||this.currentUserId==this.targetUserId},loadAmount(){return this.isMobile?20:40},filteredResults(){let e=[...this.results];return e=e.filter(t=>{var r;return((r=t==null?void 0:t.feedback)==null?void 0:r.isHidden)!=!0}),this.ownedBy!="me"||this.ownedBy=="me"&&(e=e.filter(t=>(t==null?void 0:t.permissionUserId)==this.currentUserId&&(t==null?void 0:t.permission)=="owner")),e},ownedByText(){var e;return(e=this.ownedByOptions.find(t=>t.value==this.ownedBy))==null?void 0:e.text},orderByText(){var e;return(e=this.orderByOptions.find(t=>t.value==this.orderBy))==null?void 0:e.text}},methods:{async loadTargetUserInfo(){this.loading=!0,this.targetUser=await A(this.targetUserId),this.loading=!1},async savePageSettings(){this.isCurrentUser&&await v.set(this.currentUserId,"libraryPageSettings",{filterName:this.filterName,orderBy:this.orderBy,ownedBy:this.ownedBy})},async loadPageSettings(){if(!this.isCurrentUser)return;const e=await v.get(this.currentUserId,"libraryPageSettings");e&&(this.orderBy=e.orderBy,this.ownedBy=e.ownedBy)},filterNamePretty(e){return e=="toplevel"?"Top Level":e=="suggested"?"Pinned":e=="imported"?"Imported":e=="published"?"Published":e=="all"?"All":e},backgroundClassName:O,async loadData(e=!1){e==!0&&(this.orderBy="name",this.ownedBy="anyone"),this.searchText&&(this.filterName="all"),this.filterName=="toplevel"?this.loadLibraryRoot():this.filterName=="suggested"?this.loadPinned():this.listAllCollections(this.filterName)},filterBy(e){this.filterName=e,this.loadData(),this.savePageSettings()},async updateOwnedBy(){this.ownedBy=="me"?this.ownedBy="anyone":this.ownedBy="me"},async runCollectionSearch(){this.loading=!0;const e=await this.apiReq("/client/collection/listByUser",{userId:this.targetUserId,includeUserPermissions:!0,includeParents:!0});e.success&&(this.results=p(e.result),this.orderBy="name",await this.processSearch(),this.updateOrder(),this.errorMessage=void 0),this.loading=!1},async processSearch(){if(this.searchText!=null){let e=this.results;e=e.filter(t=>{const r=t==null?void 0:t.name;if(r&&r.toLowerCase().includes(this.searchText.toLowerCase()))return!0;const i=t==null?void 0:t.description;return!!(i&&i.toLowerCase().includes(this.searchText.toLowerCase()))}),this.results=e}},createCollection(){this.apiReq("/client/collection/create",{data:this.createCollectionForm}).then(e=>{e.success?this.loadLibraryRoot():(this.showModal("add-collection-modal"),this.showToast(e.message,{variant:"danger",title:"Error",solid:!0}))})},async selectOrderBy(e){this.orderBy=e.value,await this.savePageSettings(),this.updateOrder()},async selectedOwnedBy(e){this.ownedBy=e.value,await this.savePageSettings(),await this.loadData()},updateOrder(){let e=this.results;this.results=[],this.orderBy=="recentlyAdded"?e.sort((t,r)=>{const i=r.permissionCreatedAt||r.createdAt,g=t.permissionCreatedAt||t.createdAt,U=i?new Date(i).getTime():0,l=g?new Date(g).getTime():0;return U-l}):e.sort(function(t,r){return N(t,r,"name")}),this.results=e},async loadLibraryRoot(){this.loading=!0;try{const e=await this.apiReq("/client/library/root",{userId:this.targetUserId,includeUserPermissions:!0});this.results=p(e.result,50,!1),await this.processSearch(),await this.updateOrder(),this.errorMessage=void 0}catch(e){this.errorMessage=e==null?void 0:e.message}this.loading=!1},async loadRecentCollections(){this.errorMessage="";const e=await this.sendReq("/client/collection/recent");return e.success?p(e.result.slice(0,30)):(this.errorMessage=e.message,console.error(this.errorMessage),[])},async loadPinned(){this.loading=!0;try{await this.RefreshPinnedToHomeItems(!0);let e=await this.loadRecentCollections(),t=new Set(e.map(i=>i._id)),r=this.pinnedToHomeItems.filter(i=>!t.has(i._id));this.results=[...e,...r],await this.processSearch(),await this.updateOrder(),this.errorMessage=void 0}catch(e){this.errorMessage=e==null?void 0:e.message}this.loading=!1},async listAllCollections(e=null){this.loading=!0;const t=await this.apiReq("/client/collection/listByUser",{userId:this.targetUserId,includeUserPermissions:!0,includeParents:!0});if(t.success){let r=p(t.result);e&&(r=r.filter(i=>e=="imported"?!!i.publishId&&!i.published:e=="published"?!!i.published&&!!i.publishId:e=="family"?i.visibility=="shared":!0)),this.results=r,await this.processSearch(),this.updateOrder(),this.errorMessage=null}else console.error("Error:",t.message),this.errorMessage=t.message;this.loading=!1},closeAddSite(e){e&&(this.$router.push("/item/"+e),this.closeModal("add-item-modal"))},async loadPage(){this.pageLoading=!0,this.targetUserId=this.$route.params.userId,this.targetUserId&&await this.loadTargetUserInfo(),this.isCurrentUser?this.filterList=["toplevel","suggested","published","imported","all"]:this.filterList=["toplevel","published","imported","all"],this.$route.query.show=="notifications"?this.showModal("user-notifications-modal"):this.$route.query.show=="switchUser"&&this.showModal("switch-user-modal"),await this.loadPageSettings(),await this.loadData(),this.pageLoading=!1}},created(){this.loadPage()}}),z={key:0},H={key:1,class:"d-flex flex-gap-sm"},E=["onClick"],K={title:"sort by"},G={class:"ms-2 text-muted"},Q={key:2,class:"small text-muted d-flex align-items-center flex-gap-sm",title:"Filter by owner"},X={key:1,class:"d-flex align-items-center justify-content-between flex-gap-sm"},J={class:"mb-2 mt-3"},W=["innerHTML"];function Y(e,t,r,i,g,U){const l=u("b-icon"),k=u("b-dropdown-item"),I=u("b-dropdown"),T=u("b-dropdown-divider"),M=u("BFormInput"),S=u("b-button"),P=u("ItemList");return e.pageLoading?m("",!0):(o(),n("div",z,[h("div",{class:b(["d-flex align-items-center mx-1 flex-wrap",e.isMobile?"justify-content-between ":"justify-content-between"])},[e.showSearch?(o(),n("div",X,[a(M,{class:"my-0",modelValue:e.searchText,"onUpdate:modelValue":t[1]||(t[1]=s=>e.searchText=s),placeholder:"Search Collections",onKeyup:t[2]||(t[2]=V(s=>e.runCollectionSearch(),["enter"]))},null,8,["modelValue"]),a(S,{disabled:e.loading,onClick:t[3]||(t[3]=s=>e.runCollectionSearch()),variant:"link",class:"p-0"},{default:d(()=>[a(l,{icon:"search"})]),_:1},8,["disabled"]),a(S,{class:"p-0",disabled:e.loading,onClick:t[4]||(t[4]=s=>{e.searchText=null,e.showSearch=!1}),variant:"link"},{default:d(()=>[a(l,{icon:"x-lg"})]),_:1},8,["disabled"])])):(o(),n("div",{key:0,class:b(["d-flex align-items-center",e.isMobile?"flex-gap-xs":"flex-gap-1"])},[e.isMobile?(o(),f(I,{key:0,"no-caret":"",variant:"link","toggle-class":"text-muted btn-sm"},{"button-content":d(()=>[y(c(e.filterNamePretty(e.filterName))+" ",1),a(l,{icon:"caret-down"})]),default:d(()=>[(o(!0),n(B,null,C(e.filterList,s=>(o(),f(k,{key:s,onClick:w=>e.filterBy(s)},{default:d(()=>[y(c(e.filterNamePretty(s)),1)]),_:2},1032,["onClick"]))),128))]),_:1})):(o(),n("div",H,[(o(!0),n(B,null,C(e.filterList,s=>(o(),n("div",{role:"button",key:s,onClick:w=>e.filterBy(s),class:b(["pill px-3 nowrap",e.filterName==s?"blue-bg white-color":"fillrow "]),size:"sm"},c(e.filterNamePretty(s)),11,E))),128))])),h("div",K,[a(I,{"toggle-class":" text-muted",size:"sm",variant:"link",lazy:!0,right:""},{"button-content":d(()=>[a(l,{icon:"sort-down"}),h("span",G,c(e.orderByText?e.orderByText:"Select"),1)]),default:d(()=>[t[7]||(t[7]=h("div",{class:"text-muted text-center"},"Sort By:",-1)),a(T),(o(!0),n(B,null,C(e.orderByOptions,(s,w)=>(o(),f(k,{key:w,onClick:Z=>e.selectOrderBy(s)},{default:d(()=>[y(c(s.text),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),e.isCurrentUser?(o(),n("div",Q,[h("div",{role:"button",class:"hoverrow my-0 nowrap px-1",onClick:t[0]||(t[0]=s=>e.updateOwnedBy())},[a(l,{icon:e.ownedBy=="me"?"check-square":"square",class:"me-1"},null,8,["icon"]),t[8]||(t[8]=y(" Owned by me "))])])):m("",!0)],2)),e.showSearch?m("",!0):(o(),n("div",{key:2,role:"button",onClick:t[5]||(t[5]=s=>e.showSearch=!e.showSearch),class:"text-muted btn btn-link py-0"},[a(l,{icon:"search"})]))],2),h("div",J,[e.errorMessage?m("",!0):(o(),f(P,{key:0,loading:e.loading,items:e.filteredResults,onUpdate:t[6]||(t[6]=s=>e.loadData()),itemViewOptions:{hideCollectionBadge:!0},loadAmount:e.loadAmount,hideFeedback:!e.isCurrentUser},null,8,["loading","items","loadAmount","hideFeedback"])),e.errorMessage?(o(),n("div",{key:1,class:"text-center text-muted",innerHTML:e.errorMessage},null,8,W)):m("",!0)])]))}const ke=$(j,[["render",Y]]);export{ke as default};
