import{a as R,_ as C,P as N,Q as M,V as z,p as q,aL as W,av as j,d as F,o as Y}from"./components.globalDizx_NTC.js";import{c as x}from"./item.storeCI0d-UrP.js";import{u as O}from"./upload.mixinCs4F8zrX.js";import{d as B,j as o,k as i,K as l,z as m,F as P,P as S,s as b,r as d,i as a,m as g,R as U,Q as A,L,ac as H,N as J}from"./@vueC3Nhqlrl.js";import{I as K}from"./ItemImageDmIqiyLE.js";import{U as Q}from"./UploadItemImageD8_IjZcF.js";import{r as G}from"./@mozillaCDB2aYYy.js";import{T as X}from"./TIIconDefaultB4jiNlod.js";const Z=B({name:"UploadItemAttachment",mixins:[R,O],props:{itemId:{type:String,required:!0}},emits:["update"],data(){return{files:null,loading:!1,item:null}},mounted(){},computed:{},methods:{async loadItemInfo(){try{const e=await x({itemId:this.itemId,detailsOnly:!0});this.item=e==null?void 0:e.details}catch(e){console.error(e.message)}},selectFiles(e){this.files=e.target.files},async upload(){try{this.loading=!0;let e=[];for(let t=0;t<this.files.length;t++){const s=this.files[t];e.push(await this.uploadFile(this.item,s))}if(e.includes(!1))this.showToast("Error uploading some attachment(s)",{variant:"danger"}),this.$emit("update");else{this.showToast("Attachment(s) uploaded successfully"),this.$emit("update");return}}catch(e){console.error(e),this.showToast("Error uploading attachment(s)",{variant:"danger"})}finally{this.loading=!1}},close(){}},created(){this.loadItemInfo()}}),ee={class:"mt-4"},te={key:0,class:"mt-4"},ae={class:"me-2"},ie={class:"w-100"},se={class:"small"},oe={key:0,class:"small text"},ne={class:"mt-4 d-flex align-items-center justify-content-between"},le={key:1};function de(e,t,s,I,c,u){const w=d("b-form-group"),n=d("b-icon"),_=d("b-spinner"),k=d("b-button");return a(),o("div",null,[i("div",null,[i("div",ee,[l(w,{class:"form-group",label:"",description:"upload one or more attachments for this item"},{default:m(()=>[i("input",{multiple:"",class:"form-control",type:"file",onChange:t[0]||(t[0]=(...f)=>e.selectFiles&&e.selectFiles(...f)),accept:"image/jpeg, image/png, image/gif, video/mp4, video/quicktime, video/x-msvideo, video/x-ms-wmv, video/x-flv, video/webm, video/3gpp, video/3gpp2, video/avi, video/mpeg, video/ogg, video/x-matroska, video/x-ms-asf"},null,32)]),_:1}),e.files&&e.files.length?(a(),o("div",te,[(a(!0),o(P,null,S(e.files,(f,h)=>(a(),o("div",{key:h,class:"d-flex align-items-center"},[i("div",ae,[f.type.includes("image")?(a(),g(n,{key:0,icon:"image",variant:"primary"})):f.type.includes("video")?(a(),g(n,{key:1,icon:"film",variant:"primary"})):(a(),g(n,{key:2,icon:"file-earmark",variant:"primary"}))]),i("div",ie,[i("div",se,U(f.name),1),f.size>4e7?(a(),o("div",oe,t[1]||(t[1]=[i("span",{class:"text-danger"},"File size exceeds 40MB",-1)]))):b("",!0)])]))),128))])):b("",!0),i("div",ne,[l(k,{class:"ms-auto",onClick:e.upload,variant:"outline-primary",disabled:e.loading},{default:m(()=>[e.loading?(a(),g(_,{key:0,small:""})):(a(),o("span",le,"Upload"))]),_:1},8,["onClick","disabled"])])])])])}const re=C(Z,[["render",de]]),me=B({name:"AttachementPreviewImage",components:{TIIconDefault:X},props:{attachment:{type:Object,required:!0},useOriginal:{type:Boolean,default:!1}},data(){return{src:null}},methods:{async getImagePath(e){},async loadImage(){let e=this.attachment.fileId,t=this.attachment.fileType;if(!(!t||!t.startsWith("image")))try{const s=await N(e);if(s){this.src=s;return}let I;this.useOriginal||(I=void 0),M("/client/userfile/getById",{id:e},{defaultPrefix:"image/jpeg"}).then(c=>{let u=c.result.trim();u&&z(e,u),this.src=u})}catch(s){console.error("Error loading image",s)}}},watch:{item(){this.loadImage()}},created(){this.loadImage()}}),ce=["src"];function pe(e,t,s,I,c,u){return e.src?(a(),o("img",{key:0,src:e.src},null,8,ce)):b("",!0)}const ue=C(me,[["render",pe]]),he=B({name:"UploadItemAttachmentOther",mixins:[R,O],props:{itemId:{type:String,required:!0}},emits:["update"],data(){return{loading:!1,item:null,attachmentTypes:[{value:"youtube",text:"Youtube Video"}],objData:{youtubeId:null},objType:"youtube",name:null}},mounted(){},computed:{},methods:{async loadItemInfo(){try{const e=await x({itemId:this.itemId,detailsOnly:!0});this.item=e==null?void 0:e.details}catch(e){console.error(e.message)}},async upload(){if(!this.isAdminUser){this.showToast("You do not have permission to upload these types of attachments",{variant:"danger"});return}if(!this.name){this.showToast("Please enter a name",{variant:"danger"});return}try{this.loading=!0,await this.uploadAttachmentObj(this.item,this.objData,this.name,"obj/"+this.objType),this.$emit("update")}catch(e){console.error(e),this.showToast("Error uploading attachment(s)",{variant:"danger"})}finally{this.loading=!1}},close(){}},created(){this.loadItemInfo()}}),fe={key:0},ge={class:"mt-4"},ye={class:"mt-4 d-flex align-items-center justify-content-between"},ve={key:1},be={key:1},Ie={class:"mt-4"};function we(e,t,s,I,c,u){const w=d("b-form-input"),n=d("b-form-group"),_=d("b-form-select"),k=d("b-spinner"),f=d("b-button"),h=d("b-alert");return a(),o("div",null,[e.isAdminUser?(a(),o("div",fe,[i("div",ge,[l(n,{class:"form-group",label:"Name",description:"Enter the name of the attachment"},{default:m(()=>[l(w,{class:"form-control",modelValue:e.name,"onUpdate:modelValue":t[0]||(t[0]=p=>e.name=p)},null,8,["modelValue"])]),_:1}),l(n,{class:"form-group",label:"Type",description:"Select the type of the attachment"},{default:m(()=>[l(_,{modelValue:e.objType,"onUpdate:modelValue":t[1]||(t[1]=p=>e.objType=p),options:e.attachmentTypes},null,8,["modelValue","options"])]),_:1}),e.objType=="youtube"?(a(),g(n,{key:0,class:"form-group",label:"Youtube Video ID"},{default:m(()=>[l(w,{class:"form-control",modelValue:e.objData.youtubeId,"onUpdate:modelValue":t[2]||(t[2]=p=>e.objData.youtubeId=p),placeholder:"Enter the Youtube Video ID"},null,8,["modelValue"])]),_:1})):b("",!0),i("div",ye,[l(f,{class:"ms-auto",onClick:e.upload,variant:"outline-primary",disabled:e.loading},{default:m(()=>[e.loading?(a(),g(k,{key:0,small:""})):(a(),o("span",ve,"Upload"))]),_:1},8,["onClick","disabled"])])])])):(a(),o("div",be,[i("div",Ie,[l(h,{show:"",variant:"danger",dismissible:"",onDismissed:e.close,class:"mb-4"},{default:m(()=>t[3]||(t[3]=[A(" You do not have permission to upload these types of attachments ")])),_:1},8,["onDismissed"])])]))])}const _e=C(he,[["render",we]]);async function E(e){return decodeURIComponent(atob(e))}let ke=`
          body {

            font-family: 'Poppins', sans-serif;
            line-height: 1.5;
            font-size: 14px;
            padding: 20px;
          }

          h1, h2, h3, h4, h5, h6 {
            margin-bottom: 20px;
          }

          img {
            max-width: 100%;
          }

          p {
            margin-bottom: 20px;
            color: #333;
          }

          a {
            color: #3498db;
          }

          a:hover {
            text-decoration: underline;
          }

          pre {
            background: #f4f4f4;
            padding: 20px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            border-radius: 5px;
            overflow: auto;
          }

          blockquote {
            background: #f9f9f9;
            border-left: 10px solid #ccc;
            margin: 20px;
            padding: 20px;
          }

          code {
            background: #f4f4f4;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
          }

          .page {
            max-width: 500px;
            margin: auto;
          }

          .container{
            max-width: 500px;
            margin: auto;
          }

          picture.img {
            max-width: 100%;
            text-align: center;
            border-radius: 10px;
          }
          
          `;const $e=B({name:"ItemAttachments",mixins:[R],emits:["update"],components:{UploadItemAttachments:re,UploadItemAttachmentOther:_e,ItemImage:K,UploadItemImage:Q,AttachmentPreviewImage:ue},props:{item:{type:Object,required:!0}},data(){return{attachments:null,previewAttachment:null,loading:!0,selectedImage:null,imageKey:0}},mounted(){},computed:{},methods:{prettyTimePast:q,async uploadBanner(){W(),this.selectedImage=null,this.closeModal("upload-attachment-image-modal"),this.$emit("update"),this.imageKey++},async remove(e){await this.confirmModal("Are you sure you want to remove this attachment?")&&(await this.sendReq("/item/attachment/remove",{itemId:this.item._id,attachmentId:e.id}),this.loadData(),this.$emit("update"),this.showToast("Attachment removed",{variant:"success"}))},async updateAttachments(){this.closeModal("upload-item-attachments-modal"),this.closeModal("upload-item-obj-attachment-modal"),await this.loadData(),this.$emit("update")},async getFileDataURL(e){let t=await this.getUserFileById(e.fileId);return j(t,e.fileType||"application/octet-stream")},async setBanner(e){let t=await this.getUserFileById(e.fileId),s=await j(t,e.fileType||"application/octet-stream");this.selectedImage=s,console.log("Selected Image",this.selectedImage),this.showModal("upload-attachment-image-modal")},getPreviewImage(e){if(e.previews&&e.previews.length>0){let t=e.previews[0];return j(t.data,t.type||"image/jpeg")}return null},async download(e){if(e.type=="file")if(e.fileType.startsWith("obj")){let t=await this.getUserFileById(e.fileId,!0);console.log("fileData",t),JSON.parse(t);const s=new Blob([t],{type:"application/json"}),I=URL.createObjectURL(s);let c=document.createElement("a");c.href=I,c.download=e.filename,c.click()}else{let t=await this.getFileDataURL(e),s=document.createElement("a");s.href=t,s.download=e.filename,s.click()}if(e.type=="snapshot"){let t=await this.getUserFileById(e.fileId),s=await E(t);JSON.parse(s)}},async openAttachment(e,t={}){if(e.type=="file"){let s=await this.getFileDataURL(e);this.previewAttachment={...e,fileDataURL:s},this.showModal("preview-item-attachments-modal")}else if(e.type=="snapshot"){let s=await this.getUserFileById(e.fileId),I=await E(s),c=JSON.parse(I);F("HTML parsed data",c);let u=c.html,w=c.baseURI||"";u.includes('<base href="')?u=u.replace(/<base href=".*">/g,`<base href="${w}">`):u=`<base href="${w}">`+u;let n=new DOMParser().parseFromString(u,"text/html"),_=c.styleSheetData||[];c.jsFileData;let k=c.imageLookup||{};for(let p of _){let y=document.createElement("style"),v=document.createTextNode(p);y.appendChild(v),n.head.appendChild(y)}let f=n.getElementsByTagName("img");for(let p of f){let y=p.src;if(y.startsWith("data:"))continue;let v=k[y];F("src",y,v),v&&(p.src=v)}if((t==null?void 0:t.pretty)==!0){let p=new G.Readability(n).parse();F("article",p),n=new DOMParser().parseFromString(p.content,"text/html");let y=document.createElement("style"),v=document.createTextNode(ke);y.appendChild(v),n.head.appendChild(y);let $=document.createElement("div");$.className="container";let T=document.createElement("h1");T.textContent=e.filename,$.appendChild(T),n.body.insertBefore($,n.body.firstChild)}let h=await Y("","_blank");h.document.write(n.documentElement.innerHTML),h.document.title=e.filename,h.history.pushState({},e.filename,e.filename)}},async getUserFileById(e,t=!1){return(await this.apiReq("/client/userfile/getById",{id:e},{excludePrefix:t})).result},async loadAttachments(){var e,t;if(this.attachments=[],(t=(e=this.item)==null?void 0:e.attachments)!=null&&t.entries)for(let s of this.item.attachments.entries)this.attachments.push(s)},async loadData(){this.loading=!0,await this.loadAttachments(),this.loading=!1}},watch:{item(){this.loadData()}},created(){this.loadData()}}),Ae={key:0,class:"previewBox"},Ue={key:0},Te=["src"],De={key:1},Ce=["src"],Be={key:2},je=["srcdoc"],Fe={key:3},Le={class:"mt-2"},Re={key:0},Ee={class:"my-2"},xe={class:"bannerPreviewContainer",role:"button"},Oe={class:"mb-4 mt-4 d-flex flex-gap-1"},Pe={key:0,class:"rounded border toverflow"},Se={class:"d-flex flex-gap-1 flex-wrap"},Ve=["onClick"],Ne={class:"toverflow"},Me={class:"d-flex flex-gap-sm flex-wrap"},ze={class:"wwrap"},qe={class:"small"},We={class:"text-muted"},Ye={class:"small text-muted"},He={class:""},Je={key:0,class:"text-muted small p-2"},Ke={key:1,class:"text-muted small p-2"},Qe={key:2,class:"text-muted small p-2"};function Ge(e,t,s,I,c,u){var T;const w=d("UploadItemImage"),n=d("b-modal"),_=d("UploadItemAttachments"),k=d("UploadItemAttachmentOther"),f=d("ItemImage"),h=d("b-button"),p=d("AttachmentPreviewImage"),y=d("b-badge"),v=d("b-icon"),$=H("b-modal");return a(),o("div",null,[l(n,{lazy:"true",id:"upload-attachment-image-modal",title:"Item Image",size:"lg","hide-footer":""},{default:m(()=>[e.item?(a(),g(w,{key:0,itemId:e.item._id,onClose:t[0]||(t[0]=r=>e.uploadBanner()),defaultImage:e.selectedImage},null,8,["itemId","defaultImage"])):b("",!0)]),_:1}),l(n,{lazy:"true",id:"preview-item-attachments-modal",title:"Preview","hide-footer":"",size:"xl",onClose:t[2]||(t[2]=r=>e.previewAttachment=null)},{default:m(()=>[e.previewAttachment?(a(),o("div",Ae,[e.previewAttachment.fileType.startsWith("video")?(a(),o("div",Ue,[i("video",{onClick:t[1]||(t[1]=J(()=>{},["stop"])),src:e.previewAttachment.fileDataURL,controls:"",autoplay:"",style:{width:"100%",height:"auto"},class:"largeVideo"},null,8,Te)])):e.previewAttachment.fileType.startsWith("image")?(a(),o("div",De,[i("img",{src:e.previewAttachment.fileDataURL,class:"largeImage"},null,8,Ce)])):e.previewAttachment.fileType.startsWith("html")?(a(),o("div",Be,[i("iframe",{srcdoc:e.previewAttachment.html,class:"lageIframe"},null,8,je)])):(a(),o("div",Fe,[t[5]||(t[5]=i("div",{class:"text-muted"},"Unsupported file type",-1)),A(" "+U(e.previewAttachment),1)]))])):b("",!0)]),_:1}),l(n,{lazy:"true",id:"upload-item-attachments-modal",title:"Upload Attachment","hide-footer":"",size:"lg"},{default:m(()=>[l(_,{itemId:e.item._id,onUpdate:t[3]||(t[3]=r=>e.updateAttachments())},null,8,["itemId"])]),_:1}),l(n,{lazy:"true",id:"upload-item-obj-attachment-modal",title:"Add Attachment","hide-footer":"",size:"lg"},{default:m(()=>[l(k,{itemId:e.item._id,onUpdate:t[4]||(t[4]=r=>e.updateAttachments())},null,8,["itemId"])]),_:1}),i("div",Le,[e.item?(a(),o("div",Re,[i("div",Ee,[t[6]||(t[6]=i("div",{class:"mb-3 text-muted"},"Banner/preview Image",-1)),L((a(),o("div",xe,[(a(),g(f,{showPlaceholder:!0,item:e.item,key:(T=e.item)==null?void 0:T.defaultImage,"icon-size":3,class:"rounded bannerPreview shadow"},null,8,["item"]))])),[[$,void 0,void 0,{"upload-attachment-image-modal":!0}]])]),t[11]||(t[11]=i("hr",null,null,-1)),i("div",Oe,[L((a(),g(h,{variant:"outline-primary"},{default:m(()=>t[7]||(t[7]=[A(" Add File")])),_:1})),[[$,void 0,void 0,{"upload-item-attachments-modal":!0}]]),t[9]||(t[9]=A()),e.isAdminUser?L((a(),g(h,{key:0,variant:"outline-primary"},{default:m(()=>t[8]||(t[8]=[A(" Add Other")])),_:1})),[[$,void 0,void 0,{"upload-item-obj-attachment-modal":!0}]]):b("",!0)]),!e.loading&&e.attachments!=null&&e.attachments.length>0?(a(),o("div",Pe,[(a(!0),o(P,null,S(e.attachments,(r,V)=>(a(),o("div",{key:V,class:"d-flex justify-content-between hoverrow p-2 flex-gap-1 flex-wrap"},[i("div",Se,[i("div",{onClick:D=>e.openAttachment(r),role:"button",class:"localImageContainer"},[l(p,{attachment:r,useOriginal:!0,class:"rounded localImage"},null,8,["attachment"])],8,Ve),i("div",Ne,[i("div",Me,[i("div",ze,U(r.filename),1)]),i("div",qe,[A(" Type: "+U(r.type)+", ",1),i("span",We,U(r.fileType),1)]),i("div",Ye," created "+U(e.prettyTimePast(r.createDate))+" ago ",1),r.fileType&&r.fileType.includes("image")?(a(),g(y,{key:0,role:"button",onClick:D=>e.setBanner(r)},{default:m(()=>t[10]||(t[10]=[A(" Set as Banner ")])),_:2},1032,["onClick"])):b("",!0)])]),i("div",He,[i("div",null,[l(h,{variant:"link",onClick:D=>e.download(r)},{default:m(()=>[l(v,{icon:"download"})]),_:2},1032,["onClick"]),l(h,{variant:"link",onClick:D=>e.remove(r)},{default:m(()=>[l(v,{icon:"x-lg"})]),_:2},1032,["onClick"])]),i("div",null,[r.type=="snapshot"?(a(),g(h,{key:0,variant:"link",onClick:D=>e.openAttachment(r,{pretty:!0})},{default:m(()=>[l(v,{icon:"eye"})]),_:2},1032,["onClick"])):b("",!0)])])]))),128)),!e.item||e.attachments.length==0?(a(),o("div",Je," No attachments ")):b("",!0)])):e.loading?(a(),o("div",Ke,"Loading...")):(a(),o("div",Qe,"No attachments"))])):b("",!0)])])}const nt=C($e,[["render",Ge],["__scopeId","data-v-b2289bee"]]);export{nt as I};
