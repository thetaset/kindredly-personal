import{a as A,j as q,ae as k,a0 as V,d as f,_ as E}from"./components.globalDizx_NTC.js";import $ from"./PopCollectionSelectorBW6dnAeB.js";import{d as F,j as r,K as l,z as a,k as o,R as g,Q as d,s as c,r as u,i as n,F as C,P as w,m as D}from"./@vueC3Nhqlrl.js";const O=F({name:"AccessRequestApprover",mixins:[A],components:{PopCollectionSelector:$},props:["userId","url","collectionIds","requestId"],data(){return{loading:!1,loadingItem:!0,errorMessage:null,permissionLookup:{},editPatterns:!1,editURL:!1,editMeta:!1,searchText:null,searchResults:null,collections:null,itemInfo:null,requesterUser:{},requesterCollectionIds:[],selectedCollectionIds:[],loadingMeta:!1,loadingMetaFailed:!1,details:{url:null,name:null,description:null,comment:null,tags:null,patterns:null,type:"link"},meta:{title:null,description:null,keywords:null,image:null}}},mounted(){},computed:{urlOptions(){let e=[];if(!this.url||this.url=="")return e;let t=new URL(this.url);e.push(t.protocol+"//"+t.hostname);let s=t.hostname.split(".");return s.length>2&&e.push(t.protocol+"//"+s[s.length-2]+"."+s[s.length-1]),e},requesterUsername(){var e;return(e=this.requesterUser)==null?void 0:e.username},collectionList(){const e=[];if(this.collections==null||this.collections.length==0)return e;const t=new Set(this.requesterCollectionIds);for(const s of this.collections){const m=s.path?"/"+[...s.path,s.name].join("/"):`/${s.name}`;e.push({text:s.name,value:s._id,path:m,sortKey:m,hasAccess:t.has(s._id)})}return e}},methods:{isMatch(){var e;try{if(!((e=this==null?void 0:this.details)!=null&&e.url)||!this.url)return!1;const t=new URL(q(this.url)),s=new URL(this.details.url);return(t==null?void 0:t.hostname)==(s==null?void 0:s.hostname)}catch(t){return console.error("EE",this.details,this.url,t),!1}},selectURL(e){this.details.url=e,this.updatePatterns(),this.loadItemFromURL()},updatePatterns(){var e,t;this.details.url=k(this.details.url),((e=this.details)==null?void 0:e.url)!=null&&(this.details.patterns=V((t=this.details)==null?void 0:t.url))},addCollection(e){e&&(this.selectedCollectionIds.push(e),this.loadRequesterPermissions()),this.closeModal("select-modal")},async loadItemFromURL(){this.loadingItem=!0;const e=await this.sendReq("/client/item/similarItemsByURL",{url:this.details.url});if(e.success&&e.result){this.updatePatterns(),this.itemInfo=null;const{exactMatches:t,similarMatches:s}=e.result;t.length>0&&(this.itemInfo=t[0]),this.itemInfo&&this.itemInfo.details&&(this.itemInfo.collectionIds?this.selectedCollectionIds=[...this.itemInfo.collectionIds]:this.selectedCollectionIds=[],this.details=this.itemInfo.details,this.details.patterns=this.details.patterns?this.details.patterns.join(`
`):"",this.details.tags=this.details.tags?this.details.tags.join(", "):"",this.meta=this.details.meta);try{this.loadMeta(),await this.loadCollections()}catch(m){console.error("Error loading collections",m)}this.errorMessage=null}else console.error("Error:",e.message),this.errorMessage=e.message;this.loadingItem=!1},validCollections(){return!(this.selectedCollectionIds==null||this.selectedCollectionIds.length==0||this.userId&&!this.selectedCollectionIds.some(e=>this.requesterCollectionIds.includes(e)))},validateCollections(){if(this.selectedCollectionIds==null||this.selectedCollectionIds.length==0)throw"You must select at least one collection!";if(this.userId&&!this.selectedCollectionIds.some(e=>this.requesterCollectionIds.includes(e)))throw`You must select at least one collection that ${this.requesterUser.username} has access to.`},async loadMeta(){this.loadingMeta=!0,this.loadingMetaFailed=!1;try{if(f("Loading metdata for"+this.details.url),this.details.url==null){f("Undefined url, not loading meta"),this.meta={};return}let e=k(this.details.url);f("url:"+e);let s=(await this.sendReq("/client/fetchMetadata",{url:e})).result;s!=null&&(f(s),this.meta=s,this.details.name=s.title,this.details.description=s.description)}catch(e){console.error("Error loading meta",e),this.loadingMetaFailed=!0}this.loadingMeta=!1},async saveOrAddItem(){var m;f("Adding to user",this.requesterUser),this.loading=!0;let e=this.details.patterns.split(`
`);this.details.url,this.details.tags==null&&(this.details.tags="");const t={...this.details};t.tags=this.details.tags.split(",").map(function(b){return b.toLowerCase().trim()}),t.patterns=e,t.name==this.meta.title&&(t.name=null),t.description==this.meta.description&&(t.description=null),t.meta=this.meta,f("saveinfo",t,this.selectedCollectionIds);const s=await this.sendReq("/client/item/save",{itemId:t._id,details:t,collectionIds:this.selectedCollectionIds,accessRequestId:this.requestId,quickShareUserIds:[this.userId],tempAuthToken:((m=this.permissionOverrideInfo)==null?void 0:m.tokenData)||null});s.success?(this.RefreshIndexQuick(),this.clearPermissionOverrideInfo(),this.$emit("close",!0),this.errorMessage=null):(console.error("Error:",s.message),this.errorMessage=s.message,this.showToast(s.message,{variant:"danger",title:"Error",solid:!0}),this.loading=!1)},async loadCollections(){var t;const e=await this.sendReq("/client/collection/listByAccount",{ids:this.selectedCollectionIds,includePath:!0,tempAuthToken:((t=this.permissionOverrideInfo)==null?void 0:t.tokenData)||null});this.collections=e.result},async loadRequester(){this.errorMessage=null;const e=await this.sendReq("/user/info",{userId:this.userId});e.success?this.requesterUser=e.result:(console.error("Error:",e.message),this.errorMessage=e.message),this.loadRequesterPermissions()},async loadRequesterPermissions(){var t;this.errorMessage=null;const e=await this.sendReq("/item/userPermissionLookup",{userId:this.userId,tempAuthToken:((t=this.permissionOverrideInfo)==null?void 0:t.tokenData)||null});e.success?(this.permissionLookup=e.result,this.requesterCollectionIds=Object.keys(this.permissionLookup)):(console.error("Error:",e.message),this.errorMessage=e.message),this.loadCollections()},closeMe(){this.clearPermissionOverrideInfo,this.$emit("close",!1)}},created(){this.url&&(f("URL FOR ADD ITEM"+this.url),this.details.url=k(q(this.url)),this.updatePatterns(),this.loadItemFromURL()),this.loadRequester(),this.collectionIds&&(this.selectedCollectionIds=this.collectionIds)}}),T={class:"my-2"},N={class:"small mt-2"},j={class:"mb-3"},B={key:0},S={key:0,class:"mb-1 small text-muted"},z={class:"d-flex align-items-center justify-content-between"},K=["title"],Q=["href"],W={key:0,class:"text-center text-muted my-2"},Y={key:1,class:"text-center text-muted my-2"},G={key:2,class:"m-3 text-center"},H=["src"],J={key:3},X={class:"mb-2"},Z={class:"mb-2"},_={key:0,class:"mb-4 mt-4"},x={key:4},ee={key:5,class:"my-4"},te={class:"col"},se={class:"col text-muted"},le={key:0},ie={key:0},oe={class:"d-flex justify-content-between"},ne={key:1,class:"text-center mt-4"};function re(e,t,s,m,b,ae){const M=u("PopCollectionSelector"),R=u("b-modal"),v=u("b-form-textarea"),h=u("b-button"),p=u("b-icon"),I=u("b-form-group"),y=u("b-spinner"),L=u("b-form-input"),P=u("b-form");return n(),r("div",null,[l(R,{lazy:"true",id:"select-modal",size:"lg","hide-footer":"","hide-header":""},{default:a(()=>[o("div",null,[l(M,{onClose:e.addCollection,targetUserId:e.userId},null,8,["onClose","targetUserId"])])]),_:1}),l(R,{lazy:"true",id:"edit-url-modal",title:"Edit URL","ok-only":"",onOk:t[2]||(t[2]=i=>e.loadItemFromURL())},{default:a(()=>[o("div",T,[l(v,{id:"formWebsite",modelValue:e.details.url,"onUpdate:modelValue":t[0]||(t[0]=i=>e.details.url=i),placeholder:"Enter the website URL",description:"URL",required:"",onUpdate:t[1]||(t[1]=i=>e.updatePatterns())},null,8,["modelValue"]),o("div",N,[t[14]||(t[14]=o("div",{class:"text-muted ms-2 mb-2"}," Please edit above url or select from options below. ",-1)),(n(!0),r(C,null,w(e.urlOptions,i=>(n(),r("div",{key:i,class:"ms-1 my-3"},[l(h,{onClick:U=>e.selectURL(i),variant:"outline-primary",class:"me-2"},{default:a(()=>t[13]||(t[13]=[d(" select ")])),_:2},1032,["onClick"]),d(" "+g(i),1)]))),128))])])]),_:1}),o("div",j,[t[15]||(t[15]=o("div",{class:"text-muted small"},"Requesting User",-1)),o("div",null,g(e.requesterUsername),1)]),e.loadingItem?(n(),r("div",ne,[l(y,{label:"Loading..."})])):(n(),r("div",B,[e.itemInfo&&e.itemInfo.details&&e.itemInfo.details._id?(n(),r("div",S,[l(p,{icon:"exclamation-triangle"}),t[16]||(t[16]=d(" This item is in your library. "))])):c("",!0),l(P,null,{default:a(()=>[l(I,{class:"form-group"},{default:a(()=>[o("div",z,[o("div",{class:"truncateme me-2 border rounded py-1 px-2 hoverrow",title:e.details.url},[l(h,{title:"edit url",class:"m-0 p-0",variant:"link",onClick:t[3]||(t[3]=i=>{e.editURL=!0,e.showModal("edit-url-modal")})},{default:a(()=>[d(g(e.textTruncate(e.details.url,5e3)),1)]),_:1})],8,K),o("a",{href:e.details.url,target:"_blank",class:"d-flex flex-gap-sm"},[t[17]||(t[17]=d("visit ")),l(p,{icon:"box-arrow-up-right"})],8,Q)])]),_:1}),t[28]||(t[28]=o("div",{class:"mt-4"},null,-1)),e.loadingMeta?(n(),r("div",W,[l(y),t[18]||(t[18]=d(" Loading from URL "))])):c("",!0),e.loadingMetaFailed?(n(),r("div",Y,[l(p,{icon:"exclamation-triangle"}),t[19]||(t[19]=d(" Failed to load URL. Maybe it's down or invalid? "))])):c("",!0),e.meta&&e.meta.bannerImagePath?(n(),r("div",G,[o("img",{"data-test-id":"metaImage",src:e.getImagePathWithDefault(e.meta.bannerImagePath),width:"200"},null,8,H)])):c("",!0),!e.editMeta&&e.details?(n(),r("div",J,[t[21]||(t[21]=o("div",{class:"text-muted small"},"Name",-1)),o("div",X,[d(g(e.details.name||"NA")+" ",1),l(h,{title:"edit details",small:"",variant:"link",onClick:t[4]||(t[4]=i=>e.editMeta=!0),class:"smaller"},{default:a(()=>[l(p,{icon:"pencil"})]),_:1})]),t[22]||(t[22]=o("div",{class:"text-muted small"},"Description",-1)),o("div",Z,g(e.details.description||"NA"),1),e.editMeta?c("",!0):(n(),r("div",_,[t[20]||(t[20]=o("div",{class:"text-muted small"},"URI Patterns:",-1)),d(" "+g(e.textTruncate(e.details.patterns,50))+" ",1),l(h,{title:"edit details",small:"",variant:"link",onClick:t[5]||(t[5]=i=>e.editMeta=!0),class:"smaller"},{default:a(()=>[l(p,{icon:"pencil"})]),_:1})])),t[23]||(t[23]=o("hr",null,null,-1))])):(n(),r("div",x,[l(I,{class:"form-group"},{default:a(()=>[l(v,{id:"formName",modelValue:e.details.name,"onUpdate:modelValue":t[6]||(t[6]=i=>e.details.name=i),placeholder:"Enter Name",required:"",rows:"2","max-rows":"3"},null,8,["modelValue"])]),_:1}),l(I,{class:"form-group"},{default:a(()=>[l(v,{id:"formDescription",modelValue:e.details.description,"onUpdate:modelValue":t[7]||(t[7]=i=>e.details.description=i),placeholder:"Enter Description",required:"",rows:"2","max-rows":"3"},null,8,["modelValue"])]),_:1}),l(I,{class:"form-group"},{default:a(()=>[l(L,{id:"formTags",modelValue:e.details.tags,"onUpdate:modelValue":t[8]||(t[8]=i=>e.details.tags=i),placeholder:"Enter Tags seperated by commas",required:""},null,8,["modelValue"])]),_:1}),l(I,{class:"form-group",description:"Accepted URI Patterns. one per line, * is wild card. For example: *.google.com/* will match all google.com no matter the path provided"},{default:a(()=>[l(v,{id:"formPatterns",modelValue:e.details.patterns,"onUpdate:modelValue":t[9]||(t[9]=i=>e.details.patterns=i),placeholder:"Enter URI Patterns",required:"",rows:"3","max-rows":"6"},null,8,["modelValue"])]),_:1}),t[24]||(t[24]=o("hr",null,null,-1))])),l(h,{class:"mt-3 btn-primary",onClick:t[10]||(t[10]=i=>e.showModal("select-modal"))},{default:a(()=>[l(p,{icon:"plus"}),t[25]||(t[25]=d(" Add to a Collection"))]),_:1}),e.loading?c("",!0):(n(),r("div",ee,[(n(!0),r(C,null,w(e.collectionList,(i,U)=>(n(),r("div",{key:U,class:"row small"},[o("div",te,g(i.path),1),o("div",se,[i.hasAccess?c("",!0):(n(),r("div",le,[l(p,{icon:"exclamation-triangle"}),t[26]||(t[26]=d(" not in requester's library "))]))])]))),128)),e.collectionList.length==0?(n(),r("div",ie,"Not in any collections")):c("",!0)])),t[29]||(t[29]=o("hr",null,null,-1)),o("div",oe,[l(h,{variant:"secondary",onClick:t[11]||(t[11]=i=>e.closeMe())},{default:a(()=>t[27]||(t[27]=[d("Cancel")])),_:1}),l(h,{variant:"primary",class:"ms-auto",onClick:t[12]||(t[12]=i=>e.saveOrAddItem()),disabled:e.loading},{default:a(()=>[e.loading?(n(),D(y,{key:0,small:"",label:"Loading..."})):(n(),r(C,{key:1},[d("Grant Access")],64))]),_:1},8,["disabled"])])]),_:1})]))])}const ce=E(O,[["render",re]]);export{ce as A};
