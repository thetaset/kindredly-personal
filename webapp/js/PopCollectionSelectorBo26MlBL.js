import{P as N,C as O}from"./CreateCollectionC2CAQQ8x.js";import{a as R,ar as S,as as Q,_ as M,aj as w,am as T,j as V,d as m,l as y,o as A}from"./components.globalSAVxUKYX.js";import{I as _}from"./ItemImageB4O-XpFn.js";import{d as B,j as o,P as U,F as v,r as g,i,k as s,K as r,R as I,l as q,z as $,L as P,U as z,s as d,p as k,Q as h,ab as D,X as H}from"./@vueC3Nhqlrl.js";import"./TIIconDefaultBACySpee.js";import"./ai_lookup_utilszDX_hcwM.js";import"./vue3-toastifyDll2FbVh.js";import"./@capacitorCjBcbZvA.js";import"./bootstrap-vue-nextDnMzdrWQ.js";const K=B({name:"ItemSelectorList",mixins:[R],components:{ItemImage:_},emits:["selected"],props:{items:{type:Array}},data(){return{}},methods:{selectItem(e){this.$emit("selected",e._id)},textTruncate:S,prettyCollection:Q},mounted(){},computed:{},directives:{},watch:{},created(){}}),W=["onClick","title","data-test-id"],X={class:"d-flex align-items-center flex-gap-sm truncateme"},Y={class:"miniItemImageContainer"},G={class:""},J={class:"d-flex justify-content-end align-items-center flex-gap-sm"};function Z(e,t,n,c,p,b){const f=g("ItemImage");return i(!0),o(v,null,U(e.items,(u,a)=>(i(),o("div",{class:"my-2",key:a},[s("div",{role:"button",class:"collectionEntryRow",onClick:C=>e.selectItem(u),title:`${e.prettyCollection(u)} `,"data-test-id":`listItem_${u.name}`},[s("div",X,[s("div",Y,[r(f,{item:u,class:"me-1 miniItemImage"},null,8,["item"])]),s("div",G,I(u.name),1)]),s("div",J,[q(e.$slots,"default",{item:u},void 0,!0)])],8,W)]))),128)}const x=M(K,[["render",Z],["__scopeId","data-v-9fbd46c7"]]),ee=B({name:"PopCollectionSelector",mixins:[R],components:{Permissions:N,CreateCollection:O,ItemImage:_,ItemSelectorList:x},emits:["close","change","clear"],props:{listclasses:{type:String,required:!1,default:""},collectionIdToLoad:{type:String,required:!1},userId:{type:String,required:!1},hideFooterButtons:{type:Boolean,required:!1,default:!1},suggestionQuery:{type:String,required:!1,default:null},suggestionURL:{type:String,required:!1,default:null},excludeCollectionIds:{type:Array,required:!1,default:()=>[]}},data(){return{targetUserId:void 0,targetUser:void 0,page:"search",createCollectionForm:{name:null,description:null,visibility:"shared"},pathTree:void 0,collections:[],selectedCollectionId:void 0,selectedCollection:void 0,loading:!1,errorMessage:void 0,permList:void 0,customPermissions:!1,loadingCollection:!1,loadingFindItems:!0,loadingSuggestions:!1,suggestedCollections:[],searchCollections:void 0,searchText:void 0,recentCollections:[]}},mounted(){},computed:{suggestedCollectionsToShow(){return!this.excludeCollectionIds||this.excludeCollectionIds.length==0?this.suggestedCollections.map(e=>e.data):this.suggestedCollections.filter(e=>!this.excludeCollectionIds.includes(e._id)).map(e=>e.data)},currentUserType(){var e;return(e=this.currentUser)==null?void 0:e.type},libraryList(){return!this.users||!this.currentUser?[]:this.currentUserType!="admin"?[]:[...this.users].filter(e=>{var t;return e._id!=((t=this.currentUser)==null?void 0:t._id)}).sort(function(e,t){return w(e,t,"username")})},collectionOptions(){const e=[];if(this.collections==null||Object.keys(this.collections).length==0)return e;const t=new Set;return this.collections.map(n=>(n.notAddable=t.has(n._id),n)).filter(n=>this.hasEditPerm(n._id))},editPermission(){return this.hasEditPerm(this.selectedCollectionId)}},methods:{getPathString:T,prettyCollection(e,t=0){const n=T(e.path);return t>0?`${S(n,t,!0)}${e.name}`:`${n}${e.name}`},toURL:V,textTruncate:S,async setPage(e){if(this.page=e,e=="search"){await this.$nextTick();const t=document.getElementById("colSearchInput");t&&t.focus()}},async loadTargetUser(){const e=await this.sendReq("/user/info",{userId:this.targetUserId});if(!e.success){this.errorMessage=e.message,console.error(this.errorMessage);return}this.targetUser=e.result,this.loading=!1},hasEditPerm(e){return this.currentUserPermissions?this.currentUserType=="admin"||e in this.currentUserPermissions&&["owner","editor"].includes(this.currentUserPermissions[e].permission):!1},async createCollection(){let e=this.permList?this.permList.filter(n=>n.permission&&n.permission!="owner"):null;this.targetUser&&!e&&!this.selectedCollectionId&&(e=[{userId:this.targetUserId,username:this.targetUser.username,permission:"editor"}],m("Updated perm list",e));const t=await this.sendReq("/client/collection/create",{data:{...this.createCollectionForm},collectionIds:this.selectedCollectionId?[this.selectedCollectionId]:[],permList:e||[],customPermissions:this.customPermissions});if(t.success)t.result&&(m("selecting collection"),await this.RefreshCurrentUser(),await this.RefreshCurrentUserPermissions(),this.selectCollection(t.result),this.createCollectionForm.name=null,this.createCollectionForm.description=null,this.setPage("browse"),this.closeModal("create-modal"));else{this.errorMessage=t.message,console.error(this.errorMessage),this.showToast(this.errorMessage,{variant:"danger",title:"Error",solid:!0});return}},createPathString(e){let t="/";return e&&e.length>0&&(t=t+e.reverse().join("/")+"/"),t},selectCollection(e){m("selectCollection",e),this.selectedCollectionId=e,this.selectedCollectionId?this.$emit("change",this.selectedCollectionId):this.$emit("clear"),this.selectedCollectionId&&(this.page="browse"),this.collections=[],this.selectedCollectionId?(this.loadSelectedCollection(),this.loadPathTree()):(this.selectedCollection=null,this.pathTree=null),this.loadCollections()},async loadSelectedCollection(){this.loadingCollection=!0;const e=await this.sendReq("/client/collection/infoByUser",{collectionId:this.selectedCollectionId,includeUserPermissions:!0});e.success&&(this.selectedCollection=e.result),this.loadingCollection=!1},loadPermList(){this.permList=[];const e=this.selectedCollection?Object.fromEntries(this.selectedCollection.users.map(t=>[t.userId,t.permission])):{};for(const t of this.users){const n={userId:t._id,username:t.username,permission:null};if(this.targetUserId==t._id)n.permission="owner";else{let c=e[t._id]||null;c=="owner"&&(c="editor"),n.permission=c}this.permList.push(n)}this.permList.sort(function(t,n){return w(t,n,"username")})},loadPathTree(){this.sendReq("/item/pathtree",{itemId:this.selectedCollectionId}).then(e=>{e.success&&(this.pathTree=e.result.reverse())})},createModal(){this.customPermissions=!1,this.permList=void 0,this.showModal("create-modal")},loadCollections(){m("Loading collections"),this.selectedCollectionId?this._loadSubCollections():this._loadTopLevelCollections()},async runCollectionSearch(){var t;this.loading=!0;const e=await this.apiReq("/client/collection/listByUser",{userId:this.targetUserId});if(e.success){let n=e.result;this.searchText=(t=this.searchText)==null?void 0:t.trim(),this.searchText&&(n=n.filter(c=>{var f,u;const p=(f=c==null?void 0:c.details)==null?void 0:f.name;if(p&&p.toLowerCase().includes(this.searchText.toLowerCase()))return!0;const b=(u=c==null?void 0:c.details)==null?void 0:u.description;return!!(b&&b.toLowerCase().includes(this.searchText.toLowerCase()))})),this.searchCollections=y(n).sort(function(c,p){return w(c,p,"name")}),this.errorMessage=void 0}this.loading=!1},_loadSubCollections(){this.sendReq("/client/collection/listItemsWithInfoByUser",{collectionId:this.selectedCollectionId,typeFilter:"col"}).then(e=>{e.success&&(this.currentUserType=="admin"?this.collections=y(e.result):this.collections=y(e.result.filter(t=>this.currentUserPermissions&&t._id in this.currentUserPermissions)))})},async _loadTopLevelCollections(){this.loading=!0;const e=await this.sendReq("/client/library/root",{userId:this.targetUserId});if(e.success){let t=y(e.result);t.sort(function(n,c){return w(n,c,"name")}),this.collections=t,this.errorMessage=void 0}else console.error("Error:",e.message),this.errorMessage=e.message;this.loading=!1},addToCollection(e){this.$emit("change",e),this.$emit("close",e)},close(){this.$emit("close",null)},async changeLibrary(){this.loadTargetUser(),this.selectCollection(null),this.loadCollections(),this.setPage("browse")},async loadSuggestedCollections(){if(!this.suggestionQuery&&!this.suggestionURL)return;this.errorMessage="",this.loadingSuggestions=!0,await this.RefreshCurrentUserPermissions();const e=await this.sendReq("/client/collection/suggestions",{suggestionQuery:this.suggestionQuery,suggestionURL:this.suggestionURL});e.success?this.suggestedCollections=e.result.splice(0,4):(this.errorMessage=e.message,console.error(this.errorMessage)),m("suggested:",this.suggestedCollections),this.loadingSuggestions=!1},async loadRecentCollections(){this.errorMessage="";const e=await this.sendReq("/client/collection/recent");e.success?this.recentCollections=y(e.result.splice(0,10)):(this.errorMessage=e.message,console.error(this.errorMessage)),m("recent:",this.recentCollections)},async finishCreatingCollection(e){e&&this.selectCollection(e),this.closeModal("create-modal")},async openSelected(){if(this.selectedCollectionId){let e=`/collection/${this.selectedCollectionId}`;this.appName!="pop"?(this.closeAllModals(),this.$router.push(e)):(e=`/index.html#${e}`,await A(e,"_blank"))}},async loadPage(){var e;this.RefreshCurrentUserPermissions(!0),this.RefreshPrefs().then(async()=>{this.loadingFindItems=!0,await Promise.all([this.RefreshPinnedToHomeItems(),this.loadRecentCollections(),this.loadSuggestedCollections()]),this.$nextTick(()=>{this.loadingFindItems=!1})}),this.userId?(this.targetUserId=this.userId,this.loadTargetUser(),this.selectCollection(null)):(this.targetUserId=(e=this.currentUser)==null?void 0:e._id,this.collectionIdToLoad?(m("loading collection",this.collectionIdToLoad),this.selectCollection(this.collectionIdToLoad)):this.selectCollection(null))}},directives:{},watch:{suggestionQuery:{handler:function(e,t){!e||e==t||(m("old",t,"new",e),this.loadSuggestedCollections())},immediate:!0},suggestionURL:{handler:function(e,t){!e||e==t||(m("old",t,"new",e),this.loadSuggestedCollections())},immediate:!0},collectionIdToLoad:{handler:function(e,t){!e||e==t||(m("old",t,"new",e),this.selectCollection(e))},immediate:!0}},created(){this.loadPage()}}),te={class:"bigcontainer"},se={class:"d-flex align-items-center flex-gap-sm mt-0"},oe={class:"d-flex flex-gap-1 align-items-center flex-wrap mb-3"},ie={key:0},le=["value"],ne=["value"],re={class:"d-flex flex-gap-1 align-items-center"},de={key:0},ce={class:"mb-auto mt-1 ms-1"},ae={class:"form-group"},ue={class:"d-flex justify-content-between flex-gap-sm"},me={class:"mt-2"},he={key:0,class:"overflow-content"},ge={key:0},pe={key:0,class:"mt-3"},fe={title:"Suggestions",class:"small mb-2 text-muted"},Ce={key:1,class:"mt-3"},ye={title:"Starred",class:"small mb-2 text-muted"},Ie={key:2,class:"mt-3"},be={title:"Pinned",class:"small mb-2 text-muted"},we={key:1,class:"text-center mt-4 ani-fade-in-slow"},ve={class:"mt-3"},ke={key:1,class:"mt-5"},Se={class:"d-flex justify-content-between mb-2"},Ue={key:1,class:"collectionListContainer mt-3"},Le={key:0,class:"mt-2 ms-2"},Te={key:1,class:"d-flex flex-column h-100 collection-content"},$e={class:"mb-auto"},Pe={key:0,class:"alert alert-primary mb-1",role:"alert"},Re={class:"d-flex justify-content-between align-items-center p-1"},Me={class:"d-flex align-items-center flex-wrap flex-gap-xs truncateme"},_e=["onClick"],Be={key:1,class:"d-flex flex-gap-xs font-weight-strong align-items-center"},qe={class:"currentCollection"},Fe={class:"ms-1 d-flex flex-gap-1 justify-content-end align-items-center"},je=["title"],Ee={key:3},Ne={class:"overflow-content"},Oe={class:"mt-1 collectionListContainer"},Qe={key:0,title:"Read-only to me"},Ve={key:1,title:"Imported"},Ae={key:0,class:"mt-1 ms-1"},ze={key:0,class:"mt-5"},De={class:"d-flex justify-content-between mb-2"};function He(e,t,n,c,p,b){const f=g("CreateCollection"),u=g("b-modal"),a=g("b-icon"),C=g("ItemSelectorList"),F=g("b-spinner"),j=g("TIcon"),E=g("ItemImage");return i(),o("div",te,[r(u,{lazy:"true",id:"create-modal",title:"New Collection","hide-footer":"",size:"lg"},{default:$(()=>[r(f,{parentCollectionId:e.selectedCollectionId,onClose:e.finishCreatingCollection},null,8,["parentCollectionId","onClose"])]),_:1}),s("div",se,[s("div",oe,[e.isAdminUser&&e.libraryList.length>0?(i(),o("div",ie,[e.currentUser&&e.users?P((i(),o("select",{key:0,onChange:t[0]||(t[0]=l=>e.changeLibrary()),"onUpdate:modelValue":t[1]||(t[1]=l=>e.targetUserId=l),class:"form-select form-control showselectcaret"},[s("option",{value:e.currentUser._id},"My Library",8,le),(i(!0),o(v,null,U(e.libraryList,(l,L)=>(i(),o("option",{key:L,value:l._id},I(l.username)+"'s Library",9,ne))),128))],544)),[[z,e.targetUserId]]):d("",!0)])):d("",!0),s("div",re,[s("button",{class:k(["btn btn-link py-0",e.page=="search"?"text-muted":""]),onClick:t[2]||(t[2]=l=>e.setPage("search")),"data-test-id":"selectFindButton"},[r(a,{icon:"search"}),t[16]||(t[16]=h(" Find "))],2),s("button",{class:k(["btn btn-link py-0",e.page=="browse"?"text-muted":""]),onClick:t[3]||(t[3]=l=>e.setPage("browse")),"data-test-id":"selectBrowseButton"},[r(a,{icon:"folder"}),t[17]||(t[17]=h(" Browse "))],2)])])]),e.page=="search"?(i(),o("div",de,[s("div",ce,[s("div",ae,[s("div",ue,[P(s("input",{id:"colSearchInput",type:"input","onUpdate:modelValue":t[4]||(t[4]=l=>e.searchText=l),class:"form-control",autofocus:"",placeholder:"Search Collections...",onKeyup:t[5]||(t[5]=H(l=>e.runCollectionSearch(),["enter"]))},null,544),[[D,e.searchText]]),s("button",{class:"btn btn-primary",onClick:t[6]||(t[6]=l=>e.runCollectionSearch()),title:"Search Library Collections"},[r(a,{icon:"search"})]),s("button",{class:"btn btn-link",onClick:t[7]||(t[7]=l=>e.searchCollections=null)},[r(a,{icon:"x-lg"})]),s("button",{class:"btn btn-primary",title:"Create new collection",onClick:t[8]||(t[8]=l=>e.createModal())},[r(a,{icon:"folder-plus"})])]),s("div",me,[e.searchCollections?e.searchCollections?(i(),o("div",Ue,[s("div",{class:k(e.listclasses)},[r(C,{onSelected:e.selectCollection,items:e.searchCollections},null,8,["onSelected","items"])],2),e.searchCollections.length==0?(i(),o("div",Le," No Results ")):d("",!0)])):d("",!0):(i(),o("div",he,[!e.targetUserId||e.targetUserId==e.currentUserId?(i(),o(v,{key:0},[q(e.$slots,"defaultoptions",{},void 0,!0),e.loadingFindItems?(i(),o("div",we,[r(F,{class:"spinnerxl"})])):(i(),o("div",ge,[e.suggestedCollectionsToShow&&e.suggestedCollectionsToShow.length>0?(i(),o("div",pe,[s("div",fe,[r(a,{icon:"lightbulb"}),t[18]||(t[18]=h(" Suggestions "))]),r(C,{onSelected:e.selectCollection,items:e.suggestedCollectionsToShow},null,8,["onSelected","items"])])):d("",!0),e.recentCollections&&e.recentCollections.length>0?(i(),o("div",Ce,[s("div",ye,[r(a,{icon:"clock"}),t[19]||(t[19]=h(" Recent "))]),r(C,{onSelected:e.selectCollection,items:e.recentCollections},null,8,["onSelected","items"])])):d("",!0),e.pinnedToHomeItems&&e.pinnedToHomeItems.length>0?(i(),o("div",Ie,[s("div",be,[r(a,{icon:"pin-fill"}),t[20]||(t[20]=h(" Pinned "))]),r(C,{onSelected:e.selectCollection,items:e.pinnedToHomeItems},null,8,["onSelected","items"])])):d("",!0)])),t[22]||(t[22]=s("hr",null,null,-1)),s("div",ve,[s("div",{role:"button",class:"btn btn-link",onClick:t[9]||(t[9]=l=>e.setPage("browse")),title:"Browse Library"},[r(a,{icon:"folder"}),t[21]||(t[21]=s("span",{class:"ms-1"},"Browse Library ",-1))])])],64)):d("",!0),e.hideFooterButtons?d("",!0):(i(),o("div",ke,[s("div",Se,[s("button",{type:"button",class:"btn btn-secondary",onClick:t[10]||(t[10]=l=>e.close())}," Cancel ")])]))]))])])])])):(i(),o("div",Te,[s("div",$e,[e.selectedCollectionId&&!e.editPermission&&!e.loadingCollection?(i(),o("div",Pe,t[23]||(t[23]=[s("strong",null,"Read only collection:",-1),h(" You don't have permission to edit this collection. Please choose a different collection. ")]))):d("",!0),s("div",Re,[s("div",Me,[s("button",{class:"d-flex align-items-center btn-link btn p-0 m-0 larger",onClick:t[11]||(t[11]=l=>e.selectCollection(null)),title:"Library Root (Top Level)"},[r(j,{name:"library",width:18}),r(a,{icon:"house-fill"}),t[24]||(t[24]=h()),t[25]||(t[25]=s("span",null,"/",-1))]),e.pathTree?(i(!0),o(v,{key:0},U(e.pathTree,l=>(i(),o("div",{role:"button",class:"text-muted",onClick:L=>e.selectCollection(l.item._id)},I(e.textTruncate(l.item.name,16))+"/ ",9,_e))),256)):d("",!0),e.selectedCollection?(i(),o("div",Be,[s("div",qe,I(e.selectedCollection.name)+"/ ",1)])):d("",!0)]),s("div",Fe,[e.selectedCollection?(i(),o("div",{key:0,class:"miniItemImageContainer shadow-sm rounded d-flex",role:"button",onClick:t[12]||(t[12]=(...l)=>e.openSelected&&e.openSelected(...l))},[r(E,{item:e.selectedCollection,class:"miniItemImage"},null,8,["item"])])):d("",!0),e.users&&e.users.length>1&&e.selectedCollection&&e.selectedCollection.users&&e.selectedCollection.users.length>1?(i(),o("div",{key:1,class:"text-muted nowrap",title:"Users with collection in library"},[r(a,{icon:"people-fill"}),h(" "+I(e.selectedCollection.users.length),1)],8,je)):d("",!0),e.editPermission||!e.selectedCollectionId?(i(),o("button",{key:2,class:"btn btn-primary btn-sm nowrap",title:"Create new collection",onClick:t[13]||(t[13]=l=>e.createModal())},[r(a,{icon:"folder-plus"})])):(i(),o("div",Ee,"Read-only"))])]),t[26]||(t[26]=s("hr",{class:"my-1"},null,-1)),s("div",Ne,[s("div",Oe,[r(C,{onSelected:e.selectCollection,items:e.collectionOptions},{default:$(({item:l})=>[e.hasEditPerm(l._id)?d("",!0):(i(),o("span",Qe," Read-Only ")),l.publishId&&!l.published?(i(),o("span",Ve,[r(a,{icon:"cloud"})])):d("",!0)]),_:1},8,["onSelected","items"]),e.collectionOptions.length==0?(i(),o("div",Ae)):d("",!0)])])]),e.hideFooterButtons?d("",!0):(i(),o("div",ze,[s("div",De,[s("button",{type:"button",class:"btn btn-secondary",onClick:t[14]||(t[14]=l=>e.close())}," Cancel "),e.selectedCollectionId&&e.editPermission?(i(),o("button",{key:0,class:"btn btn-primary",onClick:t[15]||(t[15]=l=>e.addToCollection(e.selectedCollectionId))}," Select Collection ")):d("",!0)])]))]))])}const tt=M(ee,[["render",He],["__scopeId","data-v-a853806d"]]);export{tt as default};
