import{T as F,B as N,k as I,o as $,ar as E,f as C,_ as O}from"./components.globalBic2x0kT.js";import{m as S}from"./markedJKvyS0Pp.js";import{g as Q,_ as A,c as R,s as D,b as q,R as G}from"../kindredapp.js";import{d as B,r as w,i as a,j as d,k as t,K as p,z as T,Q as M,F as x,P as L,m as c,R as b,l as U,s as m,p as j,L as z,ab as V,X as H,N as K}from"./@vueC3Nhqlrl.js";import"./vue3-toastifyDll2FbVh.js";import"./@capacitorCjBcbZvA.js";import"./bootstrap-vue-nextDnMzdrWQ.js";import"./TIIconDefaultCMdnLD-P.js";import"./vue-routerB6Jsgi62.js";import"./browserTabsB3WsZHRs.js";import"./ItemImagelPteIRA_.js";import"./vue-plugin-load-scriptXwA-LyvJ.js";import"./bootstrapDQG5F40S.js";import"./@popperjsCCtJ9KiL.js";import"./@mozillaCDB2aYYy.js";const W=B({components:{},data:function(){return{}},computed:{...Q},methods:{}}),P=B({name:"CompanionWidget",mixins:[W],components:{TIcon:F,BIcon:N},props:{icon:{type:String,required:!1}},data(){return{showURL:!1,info:"",actionId:null,ready:!1,messageLog:[],sessionId:null,actionOptionList:[],loading:!1}},computed:{pageType(){return I.browser_mode?"browser":document.location.href.startsWith("http")?"web":"extension"},appPopupURL(){return I.browser_mode?"":chrome.runtime.getURL("index.html")},inputQueue(){return A.inputQueue}},methods:{openInternalLink(e,s="_blank"){if(I.browser_mode)$(e,s);else{let l=chrome.runtime.getURL("index.html")+e;$(l,s)}},parseMarkdown(e){let s=new S.Renderer;return s.link=function(i,l,r){return S.Renderer.prototype.link.call(this,i,l,E(r,40)).replace("<a","<a target='_blank' ")},S.parse(e,{renderer:s})},textTruncate:E,updateBoxFocus(){this.$nextTick(()=>{this.$refs.chatbox.scrollTop=this.$refs.chatbox.scrollHeight})},selectAction(e){this.info=this.actionOptionList.find(s=>s.id==e).instructions},removeFromQueue(e){A.inputQueue.splice(e,1)},resetSession(){this.messageLog=[],this.sessionId=null,this.actionOptionList=[],R()},newSession(){D(null),this.resetSession()},async sendMessage(){if(!this.ready||this.info.trim()=="")return;this.ready=!1;let e=this.prepMessageData();R(),this.messageLog.push(e),this.info="",this.actionId=null,this.actionOptionList=[],this.updateBoxFocus();let s=await C("/client/ai/userRequest",{sessionId:this.sessionId,messageData:e});this.ready=!0,this.sessionId=s.result.sessionId},prepMessageData(){let e=[];return this.inputQueue.forEach(i=>{var l;if(i.type=="item"){let r={_id:i.data._id,name:i.data.name,description:i.data.description,type:i.data.type,url:i.data.url,textContent:(l=i.data.info)==null?void 0:l.value};e.push(r)}else if(i.type=="collection"){let r={_id:i.data._id,name:i.data.name,description:i.data.description,type:i.data.type,items:i.data.items};e.push(r)}else{let r={_id:i.data._id,name:i.data.name,description:i.data.description,type:i.data.type};e.push(r)}}),{message:this.info,id:""+Date.now()+"_u",role:"user",addedContext:{actionId:this.actionId,includedInfo:e},actionOption:this.actionOptionList.find(i=>i.id==this.actionId)}},getInfo(){return this.$route.path},viewInfo(){C("/client/extension/viewInfo",{url:document.location.href})},async selectSession(e){this.resetSession(),await D(e),await this.loadSession(e)},listenForMessages(){I.browser_mode?(console.log("Adding event listner for AGENT_MESSAGE_TO_CLIENT"),document.addEventListener("AGENT_MESSAGE_TO_CLIENT",e=>{console.log("Received AGENT_MESSAGE_TO_CLIENT",e),this.messageLog.push(e.detail),this.updateBoxFocus()})):chrome.runtime.onMessage.addListener((e,s,i)=>{e.type==="AGENT_MESSAGE_TO_CLIENT"&&(this.messageLog.push(e.content),this.updateBoxFocus())}),this.$nextTick(()=>{setTimeout(()=>{this.$nextTick(()=>{this.$refs.inputRef.focus!==void 0&&this.$refs.inputRef.focus()})},300)}),this.ready=!0},async LoadCurrentSession(){let e=await q();e?this.loadSession(e):this.newSession()},async loadSession(e){var i;if(!e)return;let s=await C("/client/ai/getSessionById",{id:e});if(console.log({clientResponse:s}),s.success){this.messageLog=[];let l=s.result;if(l!=null&&l.history){this.sessionId=e;let r=l.history;for(const h of r){const{input:n,response:f}=h;if((n==null?void 0:n.type)=="userMessage"&&((i=n==null?void 0:n.data)!=null&&i.message)){let v={id:n.id,role:"user",message:n.data.message,addedContext:n.data.addedContext};this.messageLog.push(v)}f&&this.loadMessageFromResponse(f)}}l.response&&this.loadMessageFromResponse(l.response)}this.updateBoxFocus()},async suggestQuestions(){var e,s;this.loading=!0;try{let i=this.prepMessageData(),l=[...this.messageLog];l.push(i);const r=await C("/client/ai/textRequest",{instructions:"Provide a list of 1 to 4 suggested follow up questions for the user to ask the AI about the included conversation  or context. The AI is for a personal information management system  that allows users to store notes and collections of things  they care about.  The AI should provide insightful questions that  help the user learn about the topic or helps to serve the users request.",context:{messageLog:l},schema:{properties:{questions:{type:"array",items:{type:"object",properties:{text:{type:"string",description:"A question to ask the llm"},label:{type:"string",description:"A short label that can fit in a button"}}}}}}});if((e=r==null?void 0:r.result)!=null&&e.questions&&((s=r==null?void 0:r.result)==null?void 0:s.questions.length)>0){let h=r.result.questions;this.actionOptionList=h.map(n=>({id:n.text,label:n.label,instructions:n.text}))}}catch(i){console.error(i)}this.loading=!1},loadMessageFromResponse(e){var s,i,l,r,h,n,f,v;if((s=e.responseMsg)!=null&&s.respToUser||(i=e.responseMsg)!=null&&i.respToUserData){let k={id:e.id,role:"assistant",message:(l=e.responseMsg)==null?void 0:l.respToUser,messageData:(r=e.responseMsg)==null?void 0:r.respToUserData};this.messageLog.push(k)}else if((n=(h=e==null?void 0:e.responseMsg)==null?void 0:h.action)!=null&&n.actionId){let k={id:e.id,role:"assistant",message:"Agent Action: "+((v=(f=e==null?void 0:e.responseMsg)==null?void 0:f.action)==null?void 0:v.actionId)};this.messageLog.push(k)}},learnMoreAboutChatbot(){this.openInternalLink("#/helpdocs/kinbot","_blank")},async loadData(){await G(),await this.LoadCurrentSession()}},watch:{},created(){this.loadData(),this.listenForMessages()}}),X={class:"companionOpen"},J={class:"d-flex align-items-center justify-content-between topbar px-2 pt-1"},Y={class:"d-flex align-items-center"},Z={class:"bottom-input"},ee={class:"d-flex align-items-center justify-content-center mb-5"},se={key:0,class:"text-center"},te={class:"text-muted small"},oe={class:"vscroll w-100 px-3",ref:"chatbox",target:"_blank"},ie={class:"d-flex flex-gap-sm"},ne={class:"mt-05"},ae=["innerHTML"],re={key:1,class:"mt-1"},le={class:"d-flex flex-gap-sm"},de={class:"small"},ce={key:0,class:"px-2 mb-1 hoverrow"},ue={class:"d-flex flex-gap-sm"},me={class:"px-3 py-2 mt-1"},pe={class:"my-1"},he={class:"text-muted small",style:{"min-height":"22px"}},fe={key:0,class:""},ge={class:"d-flex justify-content-between"},ye={class:"d-flex flex-gap-sm"},be={class:"small"},ve=["onClick"],ke={class:"my-2 mx-2 d-flex flex-gap-sm flex-wrap"},_e={class:"d-flex align-items-center flex-gap-sm"},we={class:"d-flex align-items-center flex-gap-sm flex-grow-1"},xe=["placeholder"],Le=["disabled"],Ie=["disabled"];function Ce(e,s,i,l,r,h){const n=w("BIcon"),f=w("b-button"),v=w("b-dropdown-item"),k=w("b-dropdown"),g=w("b-icon");return a(),d("div",X,[t("div",J,[t("div",Y,[p(f,{size:"sm",onClick:s[0]||(s[0]=o=>e.newSession()),variant:"link",pill:"",class:"rounded border hoverrow py-0 px-2"},{default:T(()=>[p(n,{icon:"plus-lg"}),s[7]||(s[7]=M(" New Session "))]),_:1}),p(k,{id:"dropdown-1",text:e.sessionId,variant:"link",size:"sm","toggle-class":"text-muted"},{default:T(()=>[(a(!0),d(x,null,L(e.aiSessionList,o=>(a(),c(v,{key:o.id,onClick:y=>e.selectSession(o.id)},{default:T(()=>[M(b(o.id),1)]),_:2},1032,["onClick"]))),128))]),_:1},8,["text"])]),U(e.$slots,"default")]),t("div",Z,[t("div",ee,[!e.messageLog||e.messageLog.length==0?(a(),d("div",se,[p(g,{class:"largerx",icon:"robot"}),s[9]||(s[9]=t("div",{class:"larger mt-1"},"How can I help you?",-1)),t("div",{class:"linklike mt-3 mb-5 small",role:"button",onClick:s[1]||(s[1]=o=>e.learnMoreAboutChatbot())}," learn about Kinbot "),t("div",te,[p(g,{icon:"exclamation-circle"}),s[8]||(s[8]=M(" Experimental "))])])):m("",!0)]),t("div",oe,[(a(!0),d(x,null,L(e.messageLog,o=>{var y,_;return a(),d("div",{key:o.id,class:j(["px-2 mb-1 hoverrow",o.role!="progress_update"?"":"text-muted"])},[t("div",ie,[t("div",null,[o.role=="user"?(a(),c(n,{key:0,class:"larger",icon:"person"})):m("",!0),o.role=="assistant"?(a(),c(n,{key:1,class:"larger",icon:"robot"})):m("",!0),o.role=="progress_update"?(a(),c(n,{key:2,class:"larger",icon:"info"})):m("",!0),o.role=="system"?(a(),c(n,{key:3,class:"larger",icon:"info"})):m("",!0)]),t("div",ne,[o.message?(a(),d("div",{key:0,class:"wwrapsimple",innerHTML:e.parseMarkdown(o.message)},null,8,ae)):m("",!0),o!=null&&o.addedContext&&((y=o==null?void 0:o.addedContext)==null?void 0:y.includedInfo.length)>0?(a(),d("div",re,[(a(!0),d(x,null,L((_=o==null?void 0:o.addedContext)==null?void 0:_.includedInfo,u=>(a(),d("div",{key:u._id,class:"p-2 rounded border mb-1"},[t("div",le,[t("div",null,[u.type=="collection"?(a(),c(g,{key:0,icon:"collection"})):(a(),c(g,{key:1,icon:"file-earmark-text"}))]),t("div",null,[t("div",null,b(u==null?void 0:u.name),1),t("div",null,[t("div",de,b(e.textTruncate(u==null?void 0:u.description,120)),1)])])])]))),128))])):m("",!0)])])],2)}),128)),e.ready?m("",!0):(a(),d("div",ce,[t("div",ue,[p(n,{class:"larger",icon:"robot"}),s[10]||(s[10]=t("div",{class:"mt-05"},"...",-1))])]))],512),t("div",me,[t("div",pe,[t("div",he,b(e.info.startsWith("!")?"command mode":""),1),e.inputQueue.length>0?(a(),d("div",fe,[s[11]||(s[11]=t("div",{class:"mb-1 text-muted small"}," Context ",-1)),(a(!0),d(x,null,L(e.inputQueue,(o,y)=>{var _,u;return a(),d("div",{key:y,class:"p-2 rounded border mb-1"},[t("div",ge,[t("div",ye,[t("div",null,[o.type=="collection"?(a(),c(g,{key:0,icon:"collection"})):(a(),c(g,{key:1,icon:"file-earmark-text"}))]),t("div",null,[t("div",null,b((_=o.data)==null?void 0:_.name),1),t("div",be,b(e.textTruncate((u=o.data)==null?void 0:u.description,120)),1)])]),t("div",null,[t("div",{role:"button",onClick:Te=>e.removeFromQueue(y)},[p(g,{icon:"x"})],8,ve)])])])}),128))])):m("",!0),t("div",ke,[(a(!0),d(x,null,L(e.actionOptionList,o=>(a(),c(f,{variant:"outline-secondary",size:"sm",class:"pill nowrap",onClick:y=>e.selectAction(o.id)},{default:T(()=>[M(b(o.label),1)]),_:2},1032,["onClick"]))),256))])]),t("div",_e,[t("div",we,[z(t("textarea",{ref:"inputRef",class:"form-control input-textarea border rounded fillrow shadow-sm","onUpdate:modelValue":s[2]||(s[2]=o=>e.info=o),rows:"1",placeholder:`${e.ready?"Enter a message":"thinking..."}`,onKeydown:s[3]||(s[3]=H(K(o=>e.sendMessage(),["prevent"]),["enter"]))},null,40,xe),[[V,e.info]]),t("button",{onClick:s[4]||(s[4]=o=>e.sendMessage()),class:"btn btn-link p-1",disabled:!e.ready||e.loading},[e.ready&&!e.loading?(a(),c(n,{key:0,icon:"arrow-right-circle-fill ",class:"largerx"})):(a(),c(n,{key:1,icon:"three-dots",class:"largerx"}))],8,Le),t("button",{onClick:s[5]||(s[5]=o=>e.suggestQuestions()),class:"btn btn-link p-1",disabled:!e.ready||e.loading},[p(n,{icon:"magic",class:""})],8,Ie)]),e.pageType=="web"?(a(),d("button",{key:0,class:"btn btn-link p-1",onClick:s[6]||(s[6]=o=>e.viewInfo())},[p(n,{icon:"info-circle",class:"largerx"})])):m("",!0)]),s[12]||(s[12]=t("div",{class:"mobileBottomGap"},null,-1))])])])}const je=O(P,[["render",Ce]]);export{je as default};
