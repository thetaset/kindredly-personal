import U from"./PopCollectionSelectorCwff-9C9.js";import{P as y}from"./TIIconDefaultCMdnLD-P.js";import{S as v}from"./SelectAccountUsersBAeUorit.js";import{a as T}from"./subscription.storeBRgRghO8.js";import{a as g,_}from"./components.globalBic2x0kT.js";import{d as w,j as n,k as i,K as a,Q as b,R as L,s as u,z as R,r as l,i as d}from"./@vueC3Nhqlrl.js";const k=w({name:"UpdateSubscribers",mixins:[g],props:{refId:{type:String,required:!0},refType:{type:String,required:!0},subInfo:{type:Object,required:!1},item:{type:Object,required:!1}},components:{PopCollectionSelector:U,ProfileImage:y,SelectAccountUsers:v},data(){return{subscriptionTitle:"",loadingPage:!0,currentSubscriptionList:[],selectedUserIds:[]}},mounted(){},computed:{},watch:{subInfo(){var s,e;this.subscriptionTitle=((s=this.item)==null?void 0:s.name)+" "+((e=this.subInfo)==null?void 0:e.title)||"",this.loadUserSubscriptions()}},methods:{async updateSubscriptions(){const s=this.currentSubscriptionList.map(t=>t.userId),e=this.currentSubscriptionList.filter(t=>!this.selectedUserIds.includes(t.userId)).map(t=>t._id),o=this.selectedUserIds.filter(t=>!s.includes(t));let r=null;try{for(const c of e){const p=await this.apiReq("/subscription/removeById",{subscriptionId:c})}let t=null;this.subInfo&&(t={feedURL:this.subInfo.feedURL,sourceId:this.subInfo.id,url:this.subInfo.url,title:this.subscriptionTitle,subTitle:this.subInfo.title,description:this.subInfo.description,type:"rss",imageUrl:null});for(const c of o){const p=await this.apiReq("/client/subscription/add",{refId:this.refId,refType:this.refType,userId:c,data:t})}}catch(t){r=t}r?(console.error("Error:",r),this.showToast("Failed to update subscriptions",{variant:"danger"})):this.showToast("Subscriptions updated",{variant:"success"}),await T.RefreshSubscriptions(),await this.loadUserSubscriptions(),this.$emit("update")},async loadUserSubscriptions(){const s=await this.apiReq("/client/subscription/listForRef",{refId:this.refId,refType:this.refType});if(s.success)if(!this.subInfo)this.currentSubscriptionList=s.result,this.selectedUserIds=this.currentSubscriptionList.map(e=>e.userId);else{const e=s.result;this.currentSubscriptionList=e.filter(o=>{var r;return((r=o.data)==null?void 0:r.feedURL)==this.subInfo.feedURL}),this.selectedUserIds=this.currentSubscriptionList.map(o=>o.userId)}},async load(){this.loadingPage=!0,await this.loadUserSubscriptions(),this.loadingPage=!1}},created(){this.load()}}),P={class:"mt-2 mb-3 text-muted text-center"},q={key:0},C={key:0,class:"text-center"},V={class:""},A={key:1},$={class:"d-flex justify-content-between"},j={key:1},B={key:2,class:"text-center my-4"};function N(s,e,o,r,t,c){const p=l("b-icon"),m=l("b-form-textarea"),h=l("SelectAccountUsers"),I=l("b-button"),S=l("b-spinner");return d(),n("div",null,[i("div",P,[a(p,{icon:"info-circle"}),e[2]||(e[2]=b(" Subscribers will see recent updates this item in their subscription feed. "))]),!s.loadingPage&&s.item&&s.isAdminUser?(d(),n("div",q,[s.refType=="pub_col"||s.refType=="col"?(d(),n("div",C,[i("span",V,L(s.item.name),1)])):u("",!0),s.refType=="item_feed"||s.refType=="pub_item_feed"?(d(),n("div",A,[a(m,{modelValue:s.subscriptionTitle,"onUpdate:modelValue":e[0]||(e[0]=f=>s.subscriptionTitle=f),placeholder:"Subscription Title"},null,8,["modelValue"]),e[3]||(e[3]=i("div",{class:"small mt-1 text-muted"},"Enter a short name for this subscription.",-1))])):u("",!0),a(h,{selectedUserIds:s.selectedUserIds,"onUpdate:selectedUserIds":e[1]||(e[1]=f=>s.selectedUserIds=f),includeSelf:!0,restrictedOnly:!0},null,8,["selectedUserIds"]),e[6]||(e[6]=i("hr",null,null,-1)),i("div",$,[e[5]||(e[5]=i("div",null,null,-1)),i("div",null,[a(I,{variant:"primary",onClick:s.updateSubscriptions},{default:R(()=>e[4]||(e[4]=[b(" Save ")])),_:1},8,["onClick"])])])])):u("",!0),s.isAdminUser?u("",!0):(d(),n("div",j,e[7]||(e[7]=[i("div",{class:"text-center alert alert-warning"}," You do not have permission to manage subscriptions ",-1)]))),s.loadingPage?(d(),n("div",B,[a(S)])):u("",!0)])}const K=_(k,[["render",N]]);export{K as U};
