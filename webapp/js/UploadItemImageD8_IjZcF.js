import{a as w,ao as T,t as D,p as L,x as F,av as P,_ as k,aN as B,n as j,aO as x,aw as q,aP as A}from"./components.globalDizx_NTC.js";import{c as V,s as E}from"./item.storeCI0d-UrP.js";import{m as N,f as G}from"./vue-advanced-cropperDRfTlVFt.js";import{d as z,j as o,l as O,k as i,F as M,P as Q,s as u,r as p,i as s,K as l,R as y,Q as c,z as m,m as I,L as b,ab as S}from"./@vueC3Nhqlrl.js";const W=z({name:"SharePrompt",mixins:[w],components:{},data(){return{showDebug:!1,loading:!1,processing:!1}},mounted(){},computed:{itemList(){return this.tempShareData.filter(e=>{var t;return!!((t=e==null?void 0:e.preppedData)!=null&&t.fileType)&&e.preppedData.fileType.startsWith("image")})}},methods:{removeShareData:T,textTruncate:D,prettyTimePast:L,clearTempShareData:F,getItemPreview(e){var t;return(t=e==null?void 0:e.preppedData)!=null&&t.imagePreview?P(e.preppedData.imagePreview,e.preppedData.imageType||"image/png"):null},selectItem(e){this.$emit("selectItem",e)},tooBig(e){return e>1024*1024*this.config.maxUploadSizeMB},displaySize(e){return(e/1024/1024).toFixed(2)+" MB"}},created(){}}),_={key:0},H={class:"d-flex flex-gap-sm"},K=["onClick"],J=["src"],X=["onClick"];function Y(e,t,a,g,h,R){const v=p("b-icon");return e.itemList&&e.itemList.length>0?(s(),o("div",_,[O(e.$slots,"default",{},void 0,!0),i("div",H,[(s(!0),o(M,null,Q(e.itemList,(d,r)=>(s(),o("div",{key:r,class:"d-flex flex-column flex-gap-sm"},[i("div",{onClick:f=>e.selectItem(d),role:"button",class:"p-1 hoverfill p-1 localImageContainer"},[i("img",{src:e.getItemPreview(d),class:"localImage rounded",alt:"image"},null,8,J)],8,K),i("div",{role:"button",onClick:f=>e.removeShareData(r),class:"p-2"},[l(v,{icon:"x-lg"})],8,X)]))),128))])])):u("",!0)}const Z=k(W,[["render",Y],["__scopeId","data-v-d11cb7a7"]]),ee=z({name:"UploadItemImage",props:{itemId:{type:String,required:!0},defaultImage:{type:String,required:!1}},mixins:[w],components:{CircleStencil:N,Cropper:G,ShareItemsSelect:Z},data(){return{item:null,promptInput:"",loadingSuggestionText:!1,stencilProps:{aspectRatio:2/1,movable:!0,resizable:!0,height:300,width:600},mode:"normal",limitations:{minWidth:600,minHeight:300},imageSize:{width:null,height:null},image:null,imageUpdated:null,imageCoords:null,originalImg:null,imageURL:null,imageRefresh:0,loading:!1,uploadSource:"file"}},mounted(){},computed:{imageSourceOptions(){let e=[{text:"File Upload",value:"file"}];return this.aiImageGenEnabled&&e.push({text:"AI Generated",value:"generated"}),this.isExtension&&e.push({text:"Image URL",value:"url"}),e}},methods:{changeImage({coordinates:e,canvas:t}){this.imageSize={width:t.width,height:t.height},this.imageUpdated=t.toDataURL("image/webp",{quality:.8})},defaultPosition(){return{left:0,top:0}},defaultSize(){return{width:600,height:300}},zoom(e){try{console.log("zoom",e),this.$refs.cropper&&(this.$refs.cropper.zoom(e),this.$refs.cropper.refresh())}catch(t){console.error(t)}},async resizeDefault(e,t=1e3,a=!1,g=!0){return B({base64Image:e,maxSize:t,crop:a,keepAspectRatio:g,outputType:"image/webp"})},async generateImageQuick(){await this.suggestImageText(),await this.generateImage()},async generateImage(){this.loading=!0;const e=await this.sendReq("/usertask/generateImage",{prompt:this.promptInput+" Do not include any text in the image."});let t=e==null?void 0:e.result.data[0].b64_json;t="data:image/png;base64,"+t,this.originalImg=t;let a=await this.resizeDefault(t);this.image=a,this.loading=!1},async selectItemFromQueue(e){let{fileData:t,fileType:a}=e.preppedData,g="data:"+a+";base64,"+t;this.originalImg=g;let h=await this.resizeDefault(g);this.image=h},async loadImageFromURL(){if(this.imageURL.startsWith("data")){this.originalImg=this.imageURL;let e=await this.resizeDefault(this.imageURL);this.image=e}else{this.loading=!0;const e=await this.sendReq("/client/fetchFile",{type:"image",url:this.imageURL});let t=e==null?void 0:e.result;this.originalImg=t;let a=await this.resizeDefault(t);this.image=a,this.loading=!1}},async suggestImageText(){var e,t;this.loadingSuggestionText=!0;try{const a=await this.sendReq("/client/ai/textRequest",{instructions:"Provide a prompt to generate an image as a banner for the item included. Do not include any text in the image.",context:{item:{name:this.item.name,description:this.item.description,url:this.item.url,tags:this.item.tags}},schema:{properties:{text:{type:"string",description:"the prompt to generate an image"}}}});(e=a==null?void 0:a.result)!=null&&e.text?this.promptInput=(t=a==null?void 0:a.result)==null?void 0:t.text:this.showToast("No suggestion available")}catch(a){console.error(a)}this.loadingSuggestionText=!1},async loadItemInfo(){console.log("loadItemInfo defaultImage",this.defaultImage);try{const e=await V({itemId:this.itemId,detailsOnly:!0});if(this.item=j(e),this.promptInput=this.item.name,this.defaultImage){this.originalImg=this.defaultImage;let t=await this.resizeDefault(this.defaultImage);this.image=t}else if(this.item.imageFilename&&this.item.imageFilename.startsWith("uf_")){const t=await x(this.item.imageFilename);if(t){this.originalImg=t;let a=await this.resizeDefault(t);this.image=a}}}catch(e){console.error(e)}},loadImagePreviewFromFile(e){this.loading=!0;const t=e.target.files[0],a=new FileReader;a.onload=g=>{this.originalImg=g.target.result,q({file:t,maxSize:1e3,keepAspectRatio:!0,outputType:"image/webp"}).then(h=>{this.image=h,this.loading=!1}).catch(h=>{console.error(h)})},a.readAsDataURL(t)},removeImage(){this.sendReq("/client/item/update",{itemId:this.itemId,data:{imageFilename:null,encInfo:this.item.encInfo}}).then(e=>{e.success&&this.$emit("close",!1)})},async uploadImage(){this.loading=!0;try{this.mode=="cropper"&&(this.image=this.imageUpdated);let e=await this.resizeDefault(this.image,600);await E(e,this.itemId,this.item.encInfo)?(this.RefreshIndexQuick(),this.$emit("close",!1)):this.showToast("Error saving image. Are you sure you have permission?",{variant:"danger"})}catch(e){console.error(e),this.showToast("Error saving image. Are you sure you have permission?",{variant:"danger"})}this.loading=!1},async loadMain(){this.loadItemInfo(),A()},close(){}},watch:{defaultImage(){console.log("defaultImage changed"),this.loadItemInfo()}},created(){this.loadMain()}}),te={key:0},ie={class:"m-4"},ae={key:0,class:"cropperImageContainer"},se={key:0},oe={class:"text-muted small"},le={key:0,class:"danger-color small"},ne={key:1,class:"text-center imageSelectContainer"},re=["src"],de={class:"my-3 text-center d-flex flex-gap-1 justify-content-center"},me={key:1,class:"tmp-image-placeholder text-center"},ge={key:2,class:"tmp-image-placeholder text-center rounded py-4"},ue={key:0,class:"my-4 d-flex align-items-center flex-gap-1"},pe={class:"mt-5"},he={key:0,class:"mt-5"},ce={class:""},fe=["disabled"],Ie={class:"d-flex justify-content-end mt-2 text-muted small flex-gap-sm"},ve={key:0},ye={key:1},be={key:1,class:"mt-5"},Se={class:""},we={class:"mt-4 d-flex justify-content-start flex-gap-1 align-items center"},ke={key:0},ze={key:1},Re={class:"mt-2 d-flex align-items-center justify-content-between"};function $e(e,t,a,g,h,R){const v=p("cropper"),d=p("b-icon"),r=p("b-button"),f=p("b-spinner"),$=p("b-form-radio-group"),C=p("b-form-group"),U=p("ShareItemsSelect");return s(),o("div",null,[e.item?(s(),o("div",te,[t[22]||(t[22]=i("div",null,null,-1)),i("div",ie,[e.image&&!e.loading?(s(),o("div",ae,[e.mode=="cropper"?(s(),o("div",se,[l(v,{ref:"cropper",src:e.image,"stencil-props":e.stencilProps,"default-position":e.defaultPosition,"default-size":e.defaultSize,onChange:e.changeImage,autozoom:!1,debounce:100,"resize-image":{adjustStencil:!1},imageRestriction:"none"},null,8,["src","stencil-props","default-position","default-size","onChange"]),i("div",null,[i("div",oe,y(e.imageSize.width)+" x "+y(e.imageSize.height),1),e.imageSize&&e.imageSize.width&&(e.imageSize.width<600||e.imageSize.height<300)?(s(),o("div",le,[l(d,{icon:"exclamation-triangle-fill"}),t[8]||(t[8]=c(" Images less than 600x300 may be blury "))])):u("",!0)])])):(s(),o("div",ne,[i("img",{src:e.image,class:"rounded imageSelect"},null,8,re)])),i("div",de,[l(r,{size:"sm",onClick:t[0]||(t[0]=n=>e.mode="normal"),variant:e.mode=="normal"?"outline-secondary":"link",disabled:e.loading},{default:m(()=>[l(d,{icon:"fullscreen"})]),_:1},8,["variant","disabled"]),l(r,{size:"sm",onClick:t[1]||(t[1]=n=>e.mode="cropper"),variant:e.mode=="cropper"?"outline-secondary":"link",disabled:e.loading},{default:m(()=>[l(d,{icon:"crop"})]),_:1},8,["variant","disabled"])])])):e.loading?(s(),o("div",me,[l(f)])):(s(),o("div",ge," No Image Selected "))]),t[23]||(t[23]=i("hr",null,null,-1)),e.imageSourceOptions.length>1?(s(),o("div",ue,[t[9]||(t[9]=c(" Image Source: ")),l($,{modelValue:e.uploadSource,"onUpdate:modelValue":t[2]||(t[2]=n=>e.uploadSource=n),options:e.imageSourceOptions,buttons:""},null,8,["modelValue","options"])])):u("",!0),i("div",pe,[i("div",null,[e.uploadSource=="file"?(s(),I(C,{key:0,class:"form-group",label:"",description:"upload an image to represent this item. Image should be approximately 600 pixels (width) by 300 pixels (height)"},{default:m(()=>[i("input",{class:"form-control",type:"file",onChange:t[3]||(t[3]=(...n)=>e.loadImagePreviewFromFile&&e.loadImagePreviewFromFile(...n)),accept:"image/jpeg, image/png, image/gif, image/webp"},null,32)]),_:1})):u("",!0),l(U,{onSelectItem:e.selectItemFromQueue},{default:m(()=>t[10]||(t[10]=[i("div",{class:"mt-3 border-top pt-2 mb-2"}," Available queued images ",-1)])),_:1},8,["onSelectItem"])]),e.uploadSource=="generated"?(s(),o("div",he,[t[14]||(t[14]=i("div",{class:"text-muted mb-2 small"}," Describe the image you would like generated. Eg. A cat with wings. Note, may take several seconds. ",-1)),i("div",ce,[b(i("textarea",{disabled:e.loading||e.loadingSuggestionText,label:"Generate an image","onUpdate:modelValue":t[4]||(t[4]=n=>e.promptInput=n),placeholder:"Eg. A cat with wings.",class:"form-control rounded border"},null,8,fe),[[S,e.promptInput]]),i("div",Ie,[l(r,{variant:"link",onClick:t[5]||(t[5]=n=>e.suggestImageText()),size:"sm",pill:"",class:"border fillrow",disabled:e.loading||e.loadingSuggestionText},{default:m(()=>[e.loadingSuggestionText?(s(),I(f,{key:1,small:""})):(s(),I(d,{key:0,icon:"magic"})),t[11]||(t[11]=c(" Suggest Image Text "))]),_:1},8,["disabled"]),l(r,{onClick:e.generateImage,variant:"secondary",pill:"",size:"sm",disabled:e.loading||e.loadingSuggestionText},{default:m(()=>[e.loading?(s(),o("span",ve,"...generating")):(s(),o("span",ye,[l(d,{icon:"lightning-fill"}),t[12]||(t[12]=c(" Generate image"))]))]),_:1},8,["onClick","disabled"])]),t[13]||(t[13]=i("div",{class:"mt-4 d-flex justify-content-end flex-gap-1 align-items center"},null,-1))])])):u("",!0),e.uploadSource=="url"?(s(),o("div",be,[t[16]||(t[16]=i("div",{class:"text-muted mb-2 small"}," Enter the URL of the image you would like to use. ",-1)),i("div",Se,[b(i("textarea",{label:"Image URL","onUpdate:modelValue":t[6]||(t[6]=n=>e.imageURL=n),placeholder:"https://example.com/image.jpg",class:"form-control rounded border"},null,512),[[S,e.imageURL]]),i("div",we,[l(r,{onClick:e.loadImageFromURL,variant:"secondary",disabled:e.loading},{default:m(()=>[e.loading?(s(),o("span",ke,"...downloading")):(s(),o("span",ze,[l(d,{icon:"lightning-fill"}),t[15]||(t[15]=c(" Import Image"))]))]),_:1},8,["onClick","disabled"])])])])):u("",!0),t[19]||(t[19]=i("div",{style:{height:"1em"}},null,-1)),t[20]||(t[20]=i("hr",{class:"mt-5"},null,-1)),i("div",Re,[l(r,{class:"",onClick:t[7]||(t[7]=n=>e.removeImage()),variant:"outline-secondary",disabled:e.loading},{default:m(()=>t[17]||(t[17]=[c(" Remove Image ")])),_:1},8,["disabled"]),l(r,{class:"ms-auto",onClick:e.uploadImage,variant:"primary",disabled:e.loading||e.image==null},{default:m(()=>[e.loading?(s(),I(f,{key:0,small:"",class:"me-1"})):u("",!0),t[18]||(t[18]=c(" Save "))]),_:1},8,["onClick","disabled"])]),t[21]||(t[21]=i("div",{class:"mobileBottomGap"},null,-1))])])):u("",!0)])}const Le=k(ee,[["render",$e],["__scopeId","data-v-4195903f"]]);export{Le as U};
